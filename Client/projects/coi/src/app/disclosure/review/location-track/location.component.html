<!-- Location -->
<div class="card mb-3">
    <div class="card-header px-4 py-2 justify-content-between d-flex align-items-center">
					<h4 class="card-title ">
                            <div class="fs-16 fw-bold">Reviewers</div>
                            <!-- reviewStatusCode - (3 - Review In Progress , 7 - Review Assigned , 8 - Assigned review completed )-->
                            
                               
                            <!-- <button class=" updown-arrow mt-1" (click)="isExpanded = !isExpanded">
                                <i [ngClass]="!isExpanded?'fa-large fa fa-angle-double-down':'fa-large fa fa-angle-double-up'"
                                    class="fa-large" aria-hidden="true"></i>
                            </button> -->
                            
                    </h4>
                    <span class="d-flex">
                        <div *ngIf="coiService.isCOIAdministrator && 
                                                    ['3', '8', '7'].includes(coiDisclosure?.coiReviewStatusType?.reviewStatusCode)"
                            class=" me-2">
                            <button (click)="clearReviewModal()"
                                class="btn btn-primary fs-14 btn-sm mt-0 justify-content-center d-flex align-items-center"
                                data-bs-toggle="modal" title="Add Reviewer" data-bs-target="#add-coi-reviewer-modal">
                                <mat-icon class="me-2">person_add</mat-icon>
                                Add Reviewer
                            </button>
                        </div>
                        <button (click)="isExpanded = !isExpanded" title="Click here to collapse / expand"
                            class="toggle-header-btn align-items-center bg-white border btn d-flex justify-content-center p-0 rounded-5 shadow-sm">
                            <mat-icon>{{!!isExpanded? 'expand_less' : 'expand_more'}}</mat-icon>
                        </button>
                    </span>
    </div>
    <div class="card-body fs-14" *ngIf="isExpanded">
        <div *ngIf="!reviewerList?.length">
            <app-no-information> </app-no-information>
        </div>
    <div class="table-responsive">
        <table *ngIf="reviewerList?.length" class="table tableSkin align-middle">
            <caption class="sr-only">Review</caption>
            <thead>
                <tr>
                    <th scope="col-2" class="px-3">
                        Location
                    </th>
                    <th scope="col-2" class="px-3">
                        Reviewers
                    </th>
                    <th scope="col-3" style="width:30%" class="px-3">
                        Description
                    </th>
                    <th scope="col-2" class="px-3">
                        Assigned On
                    </th>
                    <th scope="col-2" class="px-3">
                        Review End Date
                    </th>
                    <th scope="col-2" class="px-3">
                        Days at Location
                    </th>
                    <th scope="col-3" class="px-3">
                        Status
                    </th>
                    <th scope="col-2" class="text-end table-actions-margin">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let reviewer of reviewerList; let index = index">
                    <td class="table-data fw-600">{{reviewer?.reviewLocationType?.description}}</td>
                    <td class="table-data">
                        <app-no-data-label [valueToShow]="reviewer?.assigneePersonName" [customNoDataFoundMessage]="'-- No Reviewer assigned --'">
                            <span class="fw-600">{{reviewer?.assigneePersonName}}</span>
                        </app-no-data-label>
                    </td>
                    <td style="width:30%" class="text-break">
                        <app-no-data-label [valueToShow]="reviewer?.description">
                            <span *ngIf="reviewer?.description">{{reviewer?.description.length >
                                180 && !collapseViewMore[reviewer?.coiReviewId] ? (reviewer?.description | slice:0:75)+'...' : reviewer?.description}}
                                <ng-container *ngIf="reviewer?.description.length > 180">
                                    <span (click)="collapseViewMoreOption(reviewer?.coiReviewId, collapseViewMore[reviewer?.coiReviewId])"
                                        *ngIf="reviewer?.description.length > 180" class="collapse-text fs-14 fw-medium desc-collapse">
                                        {{collapseViewMore[reviewer?.coiReviewId] ? "Read Less" : "Read More"}}
                                    </span>
                                </ng-container>
                            </span>
                        </app-no-data-label>
                    </td>
                    <td>{{reviewer?.startDate | dateFormatter }}
                    </td>
                    <td *ngIf="reviewer?.endDate">{{reviewer?.endDate | dateFormatter }}</td>
                    <td *ngIf="!reviewer?.endDate">  </td>
                    <td>{{getDaysAtLocation(reviewer.startDate, reviewer.endDate)}}</td>
                    <td>
                      <app-no-data-label *ngIf="!reviewer?.reviewStatusTypeCode"[valueToShow]="reviewer?.reviewStatusTypeCode"></app-no-data-label>
                      <span *ngIf="reviewer?.reviewStatusTypeCode" [class.text-black]="reviewer?.reviewStatusTypeCode == '1'" class="fw-medium badge bg-{{getReviewStatusBadge(reviewer?.reviewerStatusType?.reviewStatusCode)}} fs-14 rounded-5">
                      {{reviewer?.reviewerStatusType?.description}}
                      </span>
                    </td>
                    <td class="align-items-center justify-content-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <ng-container *ngIf="isMangeReviewAction">
                                <button *ngIf="reviewer.reviewStatusTypeCode == '1'" 
                                    class="btn-primary-icon d-flex align-items-center my-1" title="Start review">
                                    <mat-icon id="start-review-btn" title="Start review" class="material-icons-outlined"
                                        (click)="updateCoiReviewStage(index,reviewer,'START')">play_circle_filled</mat-icon>
                                </button>
                                <button *ngIf="reviewer.reviewStatusTypeCode == '3'"
                                    class="btn-primary-icon d-flex align-items-center my-1" title="Start review">
                                    <mat-icon id="complete-review-btn" title="Complete Review" class="material-icons-outlined"
                                        (click)="updateCoiReviewStage(index,reviewer,'COMPLETE')">stop_circle</mat-icon>
                                </button>
                            </ng-container>
                                <button class="btn-primary-icon d-flex align-items-center my-1"
                                [ngClass]="{'review-comment-position':!isMangeReviewAction}" (click)="modifyReviewComment(reviewer)">
                                    <mat-icon title="Click here to add review comment">rate_review</mat-icon>
                                </button>
                                <!-- more actions -->
                                
                                <ng-container *ngIf="isMangeReviewAction">
                                    <button  *ngIf="reviewer.reviewStatusTypeCode !== '2'" [matMenuTriggerFor]="beforeMenu"
                                        class="btn-primary-icon d-flex align-items-center my-1"
                                        role = "button"
                                        type="button"
                                        title="More Actions">
                                        <mat-icon class="btn-color">more_vert</mat-icon>
                                    </button>
                                </ng-container>
                                <mat-menu #beforeMenu="matMenu" xPosition="before">
                                    <button class=" text-nowrap border-0 rounded-0 btn btn-outline-grey fs-14 d-flex justify-content-start w-100 align-items-center py-2 px-3"
                                        id="edit-location-btn" data-bs-toggle="modal" data-bs-target="#add-coi-reviewer-modal"
                                        (click)="editReview(reviewer, index)">
                                        <mat-icon class="me-2 more-options-icon">edit</mat-icon>
                                        <span>Edit Review</span>
                                    </button>
                                    <button class="text-nowrap border-0 rounded-0 btn btn-outline-grey fs-14 d-flex justify-content-start w-100 align-items-center py-2 px-3"
                                        id="delete-Review-btn" data-bs-toggle="modal" data-bs-target="#deleteReviewModal"
                                        (click)="modifyIndex = index;reviewActionConfirmation = reviewer">
                                        <mat-icon class="me-2 more-options-icon">delete</mat-icon>
                                        <span>Delete Review</span>
                                    </button>
                                </mat-menu> 
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    </div>
</div>
<!-- Review Ends-->
<!-- DELETE MEMBER WARNING MODAL -->
<div class="modal modal-coi modal-coi fade mySkinDialog modal-opacity" tabindex="-1" id="deleteReviewModal"
    tabindex="-1" role="dialog" aria-labelledby="deleteModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Review</h5>
                <button aria-label="Close" class="btn-close fs-12" data-bs-dismiss="modal" id="dissmiss-btn"
                    type="button">
                </button>
            </div>
            <div class="modal-body">
                <p class="fs-14 mb-0">Are you sure you want to delete this review?</p>
            </div>
            <div class="modal-footer">
                <button id="prop-project-close-btn" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"
                    data-bs-toggle="modal">Cancel</button>
                <button id="prop-project-team-delete-btn" type="button" class="btn btn-primary fs-14"
                    (click)="deleteReview()" data-bs-dismiss="modal">Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-coi fade mySkinDialog" id="add-coi-reviewer-modal" role="dialog"
    data-bs-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ modifyIndex != -1 ? 'Edit Reviewer' : 'Add Reviewer' }}
                </h5>
                <button type="button" title="Close" class="btn-close fs-12" data-bs-dismiss="modal" aria-label="Close"
                    (click)="reviewDetails = {}">
                </button>
            </div>
            <div class="modal-body">
                <div class="margin-person-card mb-3">
                    <app-person-project-entity-card [personProjectOrEntity]="personProjectDetails"></app-person-project-entity-card>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label class="block-display">
                            <span class="text-danger me-1">*</span>Location</label>
                        <app-look-up (selectedResult)="onLocationSelect($event)"
                        [options]="disReviewLocation" 
                        [selectedLookUpList]="locationType"
                        [isError]="validationMap.has('location')"
                        [defaultValue]="reviewDetails.reviewLocationType ? reviewDetails.reviewLocationType.description : ''"
                        [uniqueId]="'disclosure-review-location'">
                        </app-look-up>
                        <div class="ms-2" *ngIf="validationMap.has('location')">
                            <span class="mandatory d-inline-block">{{validationMap.get('location')}}</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <label class="d-block">Reviewer</label>
                        <app-elastic [options]="personElasticOptions" [clearField]="assigneeClearField"
                                     [isError]="validationMap.has('reviewer')"
                                     [placeHolder]="'Search Reviewer'" (selectedResult)="assigneeSelect($event)">
                        </app-elastic>
                        <div *ngIf="validationMap?.has('reviewer')">
                           <span class="mandatory d-inline-block">{{validationMap?.get('reviewer')}}</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <label class="block-display">
                            <span class="text-danger me-1">*</span>Status</label>
                            <app-look-up (selectedResult)="onStatusSelect($event)"
                            [options]="disReviewStatus" [isError]="validationMap.has('reviewStatus')"
                            [selectedLookUpList]="reviewerStatusType"
                            [defaultValue]="reviewDetails.reviewerStatusType ? reviewDetails.reviewerStatusType.description : ''"
                            [uniqueId]="'disclosure-review-status'">
                            </app-look-up>
                            <div *ngIf="validationMap?.has('reviewStatus')">
                                <span class="mandatory d-inline-block">{{validationMap?.get('reviewStatus')}}</span>
                            </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-4">
                        <label class="block-display">
                            <span class="text-danger me-1">*</span>Assigned On</label>
                            <div>
                                <span class="dateField w-100">
                                  <input matInput [matDatepicker]="startDate" id="start-date-involvement" placeholder="{{datePlaceHolder}}"
                                    style="width: 100% !important" (click)="startDate.open()" autocomplete="off" class="d-inline-block form-control"
                                    [(ngModel)]="reviewStartDate" (keypress)="_commonService._keyPress($event, 'date')" (ngModelChange)="compareDates('START')"
                                    [ngClass]="(validationMap?.has('reviewStartDate')) ? 'is-invalid d-block' : ''" />
                                  <i title="Click to select Start date" (click)="startDate.open()" [class.date-field-error]="validationMap?.has('reviewStartDate')"
                                    class="fa fa-calendar fa-large insidePicker hand-cursor" title="Click to select date"></i>
                                  <mat-datepicker #startDate>
                                  </mat-datepicker>
                                </span>
                                <div class="ms-2" *ngIf="validationMap.has('reviewStartDate')">
                                    <span class="mandatory d-inline-block">{{validationMap.get('reviewStartDate')}}</span>
                                </div>
                              </div>
                    </div>
                    <div class="col-4" *ngIf="reviewDetails?.reviewStatusTypeCode == '2'">
                        <label class="d-block"><span class="text-danger me-1">*</span>Review End Date </label>
                        <div>
                            <span class="dateField w-100">
                              <input matInput [matDatepicker]="endDate" id="end-date-involvement" placeholder="{{datePlaceHolder}}"
                                style="width: 100% !important" (click)="endDate.open()" autocomplete="off" class="d-inline-block form-control"
                                [(ngModel)]="reviewEndDate" (keypress)="_commonService._keyPress($event, 'date')" (ngModelChange)="compareDates('END')"
                                [ngClass]="(validationMap?.has('reviewEndDate') || validationMap.get('endDate')) ? 'is-invalid d-block' : ''" />
                              <i title="Click to select Start date" (click)="endDate.open()" [class.date-field-error]="validationMap?.has('reviewEndDate') || validationMap.has('endDate')"
                                class="fa fa-calendar fa-large insidePicker hand-cursor" title="Click to select date"></i>
                              <mat-datepicker #endDate>
                              </mat-datepicker>
                            </span>
                            <div class="ms-2" *ngIf="validationMap.has('reviewEndDate')">
                                <span class="mandatory d-inline-block">{{validationMap.get('reviewEndDate')}}</span>
                            </div>
                            <div class="ms-2" *ngIf="validationMap.has('endDate')">
                                <span class="mandatory d-inline-block">{{validationMap.get('endDate')}}</span>
                            </div>
                          </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <label class="block-display">
                            Description</label>
                        <textarea [(ngModel)]="reviewDetails.description" appLengthValidator [isShowLimiter]="true"
                            [limit]="2000" rows="3" class="form-control"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-secondary fs-14" data-bs-dismiss="modal" id="agreement-approve-close"
                    type="button" title="Close" (click)="clearReviewModal();">Close</button>
                <button id="agreement-approve-disapprove-btn" class="btn btn-primary fs-14"
                    (click)="saveOrUpdateCoiReview();" type="button" [title]="modifyIndex != -1 ? 'Update Reviewer' : 'Add Reviewer'">
                    {{ modifyIndex != -1 ? 'Update Reviewer' : 'Add Reviewer' }}
                </button>
            </div>
        </div>
    </div>
</div>
<span (click)="clearReviewModal()" id="add-review-modal-trigger" data-bs-target="#add-coi-reviewer-modal"
    data-bs-toggle="modal" class="d-none"></span>
