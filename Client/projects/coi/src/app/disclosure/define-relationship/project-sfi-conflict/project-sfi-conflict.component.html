<div class="w-100">
    <!-- apply to all -->
    <div *ngIf="isEditMode && projectSfiRelation?.coiDisclEntProjDetails?.length" id="COI_DEFINE_RELATIONSHIP_HEADER_APPLY_ALL"
        class="d-flex align-items-center justify-content-between px-3 py-2 w-100 position-sticky top-0 z-index-5 bg-white">
        <div class="col d-flex align-items-center">
            <mat-icon aria-hidden="true" class="coi-text-light flex-shrink-0 coi-scale-9 coi-ms-n2px">info</mat-icon>
            <span class="coi-text-light fs-13">{{helpText}}</span>
        </div>
        <button type="buton" id="coi_project_sfi_apply-to_all"
            class="col-auto fs-13 btn btn-primary btn-sm" (click)="openApplyToAllModal()"
            aria-label="Click here to apply to all" title="Click here to apply to all">
            <span>Apply to All</span>
        </button>
    </div>
    <!-- sfi list table -->
    <div *ngIf="projectSfiRelation?.coiDisclEntProjDetails?.length; else showNoData" class="table-responsive coi-table-striped rounded-bottom-4 pb-1">
        <table class="table fs-14 table-striped mb-0 border-top" id="COI_DEFINE_RELATION_TABLE_{{projectSfiRelation?.projectId}}">
            <thead id="COI_DEFINE_RELATION_TABLE_{{projectSfiRelation?.projectId}}_header"
                class="position-sticky z-index-4" [style.top]="isEditMode ? '45px' : '0px'">
                <tr class="fw-600" id="COI_DEFINE_RELATION_TABLE_{{projectSfiRelation?.projectId}}_header_tr">
                    <!-- Significant Financial Interest -->
                    <th scope="col" class="col align-middle border-end" tabindex="-1">
                        <span>Significant Financial Interest</span>
                        <button title="Click here to sort SFI in {{tableSort.isSFISortDesc ? 'descending' : 'ascending'}} order"
                            attr.aria-label="Click here to sort SFI in {{tableSort.isSFISortDesc ? 'descending' : 'ascending'}} order"
                            class="btn-primary-icon p-0 ms-1" (click)="tableSort.isSFISortDesc = !tableSort.isSFISortDesc; isEditMode = !isEditMode">
                            <i aria-hidden="true" class="fa fa-sort-alpha-{{tableSort.isSFISortDesc ? 'desc' : 'asc'}}"></i>
                        </button>
                    </th>
                    <!-- edit page -->
                    <ng-container *ngIf="isEditMode">
                        <!-- Conflicts and Relationship -->
                        <th scope="col" class="col-6 align-middle" tabindex="-1">
                            <span>Conflicts and Relationship</span>
                            <button title="Click here to sort SFI in {{tableSort.isConflictSortDesc ? 'descending' : 'ascending'}} order"
                                attr.aria-label="Click here to sort SFI in {{tableSort.isConflictSortDesc ? 'descending' : 'ascending'}} order"
                                class="btn-primary-icon p-0 ms-1" (click)="tableSort.isConflictSortDesc = !tableSort.isConflictSortDesc">
                                <i aria-hidden="true" class="fa fa-sort-alpha-{{tableSort.isConflictSortDesc ? 'desc' : 'asc'}}"></i>
                            </button>
                        </th>
                    </ng-container>
                    <!-- view page -->
                    <ng-container *ngIf="!isEditMode">
                        <th scope="col" class="col align-middle border-end" tabindex="-1">Relationship between SFIs and Projects</th>
                        <th scope="col" class="col-2 align-middle border-end text-nowrap" tabindex="-1">
                            <span>Conflict Status</span>
                            <button title="Click here to sort SFI in {{tableSort.isConflictSortDesc ? 'descending' : 'ascending'}} order"
                                attr.aria-label="Click here to sort SFI in {{tableSort.isConflictSortDesc ? 'descending' : 'ascending'}} order"
                                class="btn-primary-icon p-0 ms-1" (click)="tableSort.isConflictSortDesc = !tableSort.isConflictSortDesc">
                                <i aria-hidden="true" class="fa fa-sort-alpha-{{tableSort.isConflictSortDesc ? 'desc' : 'asc'}}"></i>
                            </button>
                        </th>
                        <th scope="col" class="col-auto align-middle text-center" tabindex="-1">Actions</th>
                    </ng-container>
                </tr>
            </thead>
            <tbody *ngIf="isRelationshipExpanded">
                <ng-container *ngFor="let sfiDetails of projectSfiRelation.coiDisclEntProjDetails; let sfiIndex = index, let last = last">
                    <tr [id]="sfiDetails?.disclosureDetailsId">
                        <!-- sfi details -->
                        <td [attr.aria-label]="sfiDetails?.personEntity?.entityName" class="col-6 pt-2 border-end"
                            [id]="'sfi_name_' + sfiDetails?.disclosureDetailsId" [class.border-bottom-0]="last">
                            <div class="row gap-3">
                                <div class="col-12 d-flex gap-2">
                                    <!-- entity name -->
                                    <div class="d-flex align-items-center">
                                        <mat-icon aria-hidden="true" class="coi-text-light flex-shrink-0 coi-scale-8 coi-ms-n2px">apartment</mat-icon>
                                        <span [title]="sfiDetails?.personEntity?.entityName" class="coi-text-dark text-slice">{{sfiDetails?.personEntity?.entityName}}</span>
                                    </div>
                                    <!-- modified sign -->
                                    <span *ngIf="sfiDetails.prePersonEntityId && sfiDetails.prePersonEntityId != sfiDetails.personEntityId"
                                        class="fs-12 sfi-info-text px-2 rounded-5 rounded-pill">Modified</span>
                                </div>
                                <!-- Entity Type -->
                                <div class="col">
                                    <label for="coi_sfi_type_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}" class="coi-text-dark d-block">Entity Type</label>
                                    <div id="coi_sfi_type_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}">
                                        <app-no-data-label [valueToShow]="sfiDetails?.personEntity?.entityType">
                                            <span [title]="sfiDetails?.personEntity?.entityType"
                                                [attr.aria-label]="sfiDetails?.personEntity?.entityType"
                                                class="coi-text-light text-slice">{{sfiDetails?.personEntity?.entityType}}</span>
                                        </app-no-data-label>
                                    </div>
                                </div>
                                <!-- Country -->
                                <div class="col">
                                    <label for="coi_sfi_country_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}'"
                                        class="coi-text-dark d-block">Country</label>
                                    <div id="coi_sfi_country_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}">
                                        <app-no-data-label [valueToShow]="sfiDetails?.personEntity?.countryName">
                                            <span [title]="sfiDetails?.personEntity?.countryName"
                                                [attr.aria-label]="sfiDetails?.personEntity?.countryName"
                                                class="coi-text-light text-slice">{{sfiDetails?.personEntity?.countryName}}</span>
                                        </app-no-data-label>
                                    </div>
                                </div>
                                <!-- Relationship -->
                                <div class="col-12 d-inline-flex gap-3">
                                    <label for="coi_sfi_relation_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}" class="coi-text-dark">Relationship</label>
                                    <div id="coi_sfi_relation_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}">
                                        <app-no-data-label [valueToShow]="sfiDetails?.personEntity?.countryName">
                                            <div class="d-inline-flex align-content-center gap-2 flex-wrap">
                                                <ng-container *ngFor="let sfiRelations of sfiDetails?.personEntity?.personEntityRelations">
                                                    <div class="relationship-pill border px-2 py-1 rounded-4">
                                                        <span class="d-flex coi-purple-text">
                                                            <mat-icon aria-hidden="true" class="flex-shrink-0 me-1">{{sfiRelations?.icon}}</mat-icon>
                                                            <span class="fw-bold">{{sfiRelations?.relationshipType}} :</span>
                                                            <span class="fw-normal">{{sfiRelations?.description}}</span>
                                                        </span>
                                                    </div>
                                                </ng-container>
                                            </div>
                                        </app-no-data-label>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <!-- conflict and description for edit page -->
                        <td *ngIf="isEditMode" class="col-6" [class.border-bottom-0]="last">
                            <!-- conflict status -->
                            <div class="mb-3">
                                <label for="coi_sfi_conflict_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}" class="coi-text-dark d-block mb-1">
                                    <span class="mandatory me-1" aria-label="Mandatory field">*</span>
                                    <span>Conflict Status</span>
                                </label>
                                <!-- select -->
                                <select class="form-select form-control"
                                    [(ngModel)]="sfiDetails.projectConflictStatusCode"
                                    (ngModelChange)="saveProjectSfiConflict(sfiDetails, sfiIndex)"
                                    title="Click here to select conflict status"
                                    [class.is-invalid]="mandatoryList.has('CONFLICT_STATUS_' + sfiIndex)"
                                    id="coi_sfi_conflict_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}"
                                    name="coi_sfi_conflict_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}">
                                    <option disabled [value]="null"><span class="d-block py-2">--Select--</span></option>
                                    <ng-container *ngFor="let status of defineRelationService.coiStatusList;">
                                        <option [value]="status.projectConflictStatusCode"><span class="d-block py-2">{{status?.description}}</span></option>
                                    </ng-container>
                                </select>
                                <!-- conflict status error -->
                                <span *ngIf="mandatoryList.has('CONFLICT_STATUS_' + sfiIndex)"
                                    class="invalid-feedback">{{ mandatoryList.get('CONFLICT_STATUS_' + sfiIndex) }}</span>
                            </div>

                            <!-- description -->
                            <div class="mb-1">
                                <label for="coi_sfi_conflict_comment_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}"
                                    class="coi-text-dark d-block mb-1">
                                    <span class="mandatory me-1" aria-label="Mandatory field">*</span>
                                    <span>Define Project - SFI Relation</span>
                                </label>
                                <textarea class="form-control comment-text-box textarea-height"
                                    [(ngModel)]="sfiDetails?.disclComment.comment" rows="4"
                                    (ngModelChange)="validateDescription(sfiDetails, sfiIndex)"
                                    id="coi_sfi_conflict_comment_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}"
                                    name="coi_sfi_conflict_comment_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}_{{sfiIndex}}"
                                    appLengthValidator [limit]="2000" spellcheck="false"
                                    [class.is-invalid]="mandatoryList.has('CONFLICT_COMMENT_' + sfiIndex)"
                                    (blur)="saveProjectSfiConflict(sfiDetails, sfiIndex)"
                                    title="Click here to provide your description" placeholder="Please provide your description here"
                                    [attr.aria-label]="sfiDetails?.disclComment.comment"></textarea>
                                <!-- description error -->
                                <span *ngIf="mandatoryList.has('CONFLICT_COMMENT_' + sfiIndex)"
                                    class="invalid-feedback">{{ mandatoryList.get('CONFLICT_COMMENT_' + sfiIndex) }}</span>
                            </div>
                        </td>
                        <!-- for view page -->
                        <ng-container *ngIf="!isEditMode">
                            <!-- Relationship between SFIs and Projects -->
                            <td class="col align-middle border-end" [class.border-bottom-0]="last"
                                [class.text-center]="!sfiDetails.disclComment.comment">
                                <app-no-data-label [valueToShow]="sfiDetails.disclComment.comment">
                                    <span>{{sfiDetails.disclComment.comment}}</span>
                                </app-no-data-label>
                            </td>
                            <!-- Conflict Status -->
                            <td class="col-2 align-middle border-end" [class.border-bottom-0]="last"
                                [class.text-center]="!sfiDetails?.projectConflictStatusCode">
                                <div id="coi_sfi_project_conflict_view_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}">
                                    <app-no-data-label [valueToShow]="sfiDetails?.projectConflictStatusCode">
                                        <div class="text-nowrap">
                                            <span class="{{CONFLICT_STATUS_BADGE[sfiDetails?.projectConflictStatusCode]}}"></span>
                                            <span id="coi_project_relationship_conflict-status_{{projectSfiRelation?.projectId}}_{{sfiDetails?.entityId}}"
                                                class="badgeFont">{{sfiDetails?.coiProjConflictStatusType?.description}}</span>
                                        </div>   
                                    </app-no-data-label>
                                </div>
                            </td>
                            <!-- Actions -->
                            <td class="col-auto align-middle" [class.border-bottom-0]="last">
                                <div class="d-flex align-items-center justify-content-center w-100 h-100">
                                    <!-- conflict slider -->
                                    <button class="btn btn-primary-icon d-flex align-items-center justify-content-center rounded-circle p-2 coi-scale-9"
                                        title="Click here to open conflict slider" aria-label="Click here to open conflict slider">
                                        <span aria-hidden="true" class="btn-secondary-svg"></span>
                                    </button>
                                    <!-- comment -->
                                    <button class="btn btn-primary-icon d-flex align-items-center justify-content-center rounded-circle p-2 coi-scale-9"
                                        title="Click here to open comment" aria-label="Click here to open comment">
                                        <mat-icon aria-hidden="true" class="flex-shrink-0">rate_review</mat-icon>
                                    </button>
                                </div>
                            </td>
                        </ng-container>
                    </tr>
                </ng-container>
            </tbody>
        </table>
    </div>
    <ng-template #showNoData>
        <app-no-information customClass="mt-0"></app-no-information>
    </ng-template>
</div>
