<div class="row fs-14 m-0 py-2 switch-view-card">
    <div class="col align-self-center">
        <ng-container *ngIf="!switchRelationView">For defining SFI against project use 'SFI - Project Relationship'</ng-container>
        <ng-container *ngIf="switchRelationView">For defining project against SFI use 'Project - SFI Relationship'</ng-container>.
    </div>
    <div class="col-auto">
        <button class="btn btn-primary fs-14" (click)="switchRelationViewMode(!switchRelationView)">{{switchRelationView?
            'Project - SFI Relationship':'SFI - Project Relationship'}}</button>
    </div>
</div>

<div class="row align-items-end">
    <div class="col">
        <div class="mt-2 d-flex grey-info align-items-center position-relative" *ngIf="isEditMode">
    <span data-bs-toggle="tooltip" title="Relationship Help Text." data-bs-placement="top" class="d-inline-block">
      <mat-icon role="img"
                class="mat-icon notranslate me-2 info-icon ng-tns-c100-5 material-icons mat-ligature-font mat-icon-no-color"
                aria-hidden="true" data-mat-icon-type="font">info</mat-icon>
    </span>
            <div class="info-text fs-14">
                <div class="mt-2">
                    <i class="fa fa-angle-double-right mr-2" aria-hidden="true"></i>Projects will be displayed against
                    your
                    Active SFIs, allowing you to mark the relevant conflict status and provide a supporting description
                    for
                    your
                    decision.
                    <span *ngIf="!expandInfo" (click)="expandInfo = true" class="fw-700 cursor-pointer">...<u
                        title="Expand Relationship help text" class="fw-700">Read More</u></span>
                </div>
                <ng-container *ngIf="expandInfo">
                    <div class="mt-2">
                        <i class="fa fa-angle-double-right mr-2" aria-hidden="true"></i>If any of the active SFIs are
                        missing
                        ,please cross-check and make necessary corrections to the SFI list in the SFI section.
                    </div>
                    <div class="mt-2">
                        <i class="fa fa-angle-double-right mr-2" aria-hidden="true"></i>Before proceeding to the next
                        step,
                        ensure that all your Project-SFI relationships have been marked.
                        <span *ngIf="expandInfo && !isShowCollapsedConflictRelationship" (click)="expandInfo = false"
                              class="fw-700 cursor-pointer"><u
                            title="Collapse Relationship help text">Read Less</u></span>
                    </div>
                    <div *ngIf="isShowCollapsedConflictRelationship">
                        <div class="mt-2">
                            <i class="fa fa-angle-double-right mr-2" aria-hidden="true"></i>For marking all your SFI
                            conflict
                            status/ relationship description use "Apply and Save".
                        </div>
                        <div class="mt-2">
                            <i class="fa fa-angle-double-right mr-2" aria-hidden="true"></i>For marking individual SFI
                            conflict
                            status/ relationship description use "Save".
                            <span *ngIf="expandInfo" (click)="expandInfo = false" class="fw-700 cursor-pointer"><u
                                title="Collapse Relationship help text">Read Less</u></span>
                        </div>
                    </div>
                </ng-container>
            </div>
        </div>
    </div>
</div>


  <div class="form-control col-lg-12 col-md-12 col-12 d-flex mx-auto mt-2" *ngIf="awardList.length>1 && !switchRelationView">
    <mat-icon *ngIf="!searchText" class="mat-icon material-icons search-icon" aria-hidden="true" data-mat-icon-type="font">search</mat-icon>
    <input type="text" placeholder="Search by Project Id, Project Name, PI, Project Status, Sponsor, Prime Sponsor  "
    class="searchField  mt-2 ms-2 pb-2" [(ngModel)]="searchText">

  </div>

    <ng-container *ngIf="!switchRelationView">
        <ng-container
            *ngIf="(awardList| SearchFilter : searchText:
  ['title', 'moduleItemId', 'moduleItemKey', 'moduleStatus', 'principalInvestigator', 'sponsor', 'primeSponsor']) as searchResult; let i = index">
            <ng-container *ngIf="isShowNoDataCard">
                <div *ngIf="searchResult.length">
                    <ng-container *ngFor="let relation of searchResult;let i = index">
                        <div class="card outer-card shadow-medium" [id]="relation.moduleItemId">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8 col-12">
                                        <div class="col-12 d-flex" *ngIf="relation.moduleCode == 3">
                                            <span class="active-ribbon bg-proposal-clip shadow-sm align-items-center d-flex" tabindex='0' aria-label="proposal">Proposal</span>
                                            <p class="entity-title">
                                                <strong title="Click to view project details" tabindex="0" class="fs-16" (click)="selectedProjectForView=relation;" data-bs-toggle="modal"
                                                        data-bs-target="#moduleViewModal"[attr.aria-label]="relation?.moduleItemId + '_' + relation?.title ">#{{relation?.moduleItemId}} - {{relation?.title?.length >
                                                75 && !collapseViewMore[relation?.moduleItemId] ? (relation?.title | slice:0:75)+'...' :
                                                    relation?.title}}
                                                </strong>
                                                <span
                                                    (click)="collapseViewMoreOption(relation?.moduleItemId, collapseViewMore[relation?.moduleItemId])"
                                                    *ngIf="relation?.title?.length > 75" class="collapse-text fs-13">
                                            {{collapseViewMore[relation?.moduleItemId] ? "Read Less" : "Read More"}}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-12 d-flex" *ngIf="relation.moduleCode == 1">
                                    <span class="active-ribbon bg-award-clip shadow-sm align-items-center d-flex" tabindex='0' aria-label="Award">Award</span>
                                    <p title="Click to view project details" class="entity-title m-0" (click)="selectedProjectForView=relation" data-bs-toggle="modal"
                                        data-bs-target="#moduleViewModal"tabindex='0' >
                                        <strong class="fs-16"[attr.aria-label]="relation?.moduleItemKey + ' - ' + relation?.title">#{{relation?.moduleItemKey}} - {{relation?.title}} </strong>
                                    </p>
                                </div>
                                <div class="row m-2">
                                    <div class="col-6"tabindex="0">
                                        <label class="label-text">Principal Investigator :</label>
                                        <span class="ml-2 grey-text"[attr.aria-label]="relation?.principalInvestigator">{{relation?.principalInvestigator}}</span>
                                    </div>
                                    <div class="col-3"tabindex="0">
                                        <label class="label-text">Project Role : </label>
                                        <span class="ml-2 grey-text"[attr.aria-label]="relation?.reporterRole">{{relation?.reporterRole}}</span>
                                    </div>
                                    <div class="col-3"tabindex="0">
                                        <label class="label-text">Period :</label>
                                        <span class="ml-2 grey-text" [attr.aria-label]="relation?.startDate + ' - ' + relation?.endDate">{{relation?.startDate | dateFormatter}} - {{relation?.endDate |
                                            dateFormatter}}</span>
                                    </div>
                                    <div class="col-6"tabindex="0">
                                        <label class="label-text">Sponsor :</label>
                                        <span class="grey-text" [attr.aria-label]="relation?.sponsor">{{relation?.sponsor}}</span>
                                    </div>
                                    <div class="col-6"tabindex="0">
                                        <label class="label-text">Lead Unit :</label>
                                        <span class="ml-2 grey-text" *ngIf="relation?.unitName"[attr.aria-label]="relation?.unitName">
                                            {{_commonService.getPersonLeadUnitDetails(relation)}}</span>
                                        <span *ngIf="!relation?.unitName" class="noDataExists">No Lead Unit exist</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4 p-10">
                                <div>
                                    <div class="border h-100 rounded-1 table-bg-color position-relative">
                                        <span class="status-pill">Project/SFI Relationship</span>
                                        <div class="emptySfi mt-5 pt-3" *ngIf=" !relation.isRelationShipExists">
                                            <p class="fw-600">No SFI(s) Attached</p>
                                        </div>
                                        <div class="row fs-14 m-2" style="text-align: right;" *ngIf="relation.isRelationShipExists">
                                            <div class="col-6 mt-4">
                                                <div class="row" tabindex="0"[attr.aria-label]="'No Conflict count: ' + getDisclosureCount(1, relation.disclosureStatusCount)" >
                                                    <div class="col-6">
                                                        <label class="count-label">No Conflict : </label>
                                                    </div>
                                                    <div class="col-6" style="text-align: center;">
                                                        <span *ngIf="relation.sfiCompleted !== null"
                                                              class="fs-12 badge badge-pill badge-primary noConflict-badge">
                                                            <span>{{getDisclosureCount(1, relation.disclosureStatusCount)}}</span>
                                                        </span>
                                                                <span *ngIf="relation.sfiCompleted == null" class="count-margin">--</span>
                                                            </div>
                                                        </div>
                                                        <div class="row"tabindex="0"[attr.aria-label]="'Potential Conflict count: ' + getDisclosureCount(2, relation.disclosureStatusCount)">
                                                            <div class="col-6">
                                                                <label class="count-label">Potential Conflict :
                                                                </label>
                                                            </div>
                                                            <div class="col-6" style="text-align: center;">
                                                        <span *ngIf="relation.sfiCompleted !== null"
                                                              class="fs-12 badge badge-pill badge-primary potentialConflict-badge">
                                                            <span>{{getDisclosureCount(2, relation.disclosureStatusCount)}}</span>
                                                        </span>
                                                                <span *ngIf="relation.sfiCompleted == null" class="count-margin">--</span>
                                                            </div>
                                                        </div>
                                                        <div class="row" tabindex="0"[attr.aria-label]="'Conflict Identified count: ' + getDisclosureCount(3, relation.disclosureStatusCount)">
                                                            <div class="col-6">
                                                                <label class="count-label">Conflict Identified :</label>
                                                            </div>
                                                            <div class="col-6" style="text-align: center;">
                                                        <span *ngIf="relation.sfiCompleted != null"
                                                              class="fs-12 badge badge-pill badge-primary Conflict-badge">
                                                            <span>{{getDisclosureCount(3, relation.disclosureStatusCount)}}</span>
                                                        </span>
                                                                <span *ngIf="relation.sfiCompleted == null" class="count-margin">--</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 mt-3" style="text-align: center;">
                                                        <div class="row mt-2" *ngIf="!isShowCollapsedConflictRelationship">
                                                            <div class="col-12">
                                                                <button title="Click to {{isEditMode ? 'Define' : 'Manage'}} Project - SFI relationship"
                                                                        class="align-items-center btn btn-primary d-flex define-relation fs-14"
                                                                        (click)="openDefineRelationship(relation, i)" type="submit">
                                                                    <img src="{{deployMap}}assets/images/define-relation-hover.svg"
                                                                         class="mr-2 hover_img"
                                                                         alt="{{isEditMode ? 'Define Relationship' : 'Manage Relationship'}}">{{isEditMode
                                                                    ? 'Define Relationship' : 'Manage Relationship'}}
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-12">
                                                                <div class="disclosure-status-complete ml-15" *ngIf="relation.sfiCompleted == true" [class.mt-5]="isShowCollapsedConflictRelationship"><mat-icon
                                                                    class="complete-icon">done</mat-icon><span class="complete">Completed</span>
                                                                </div>
                                                                <div class="disclosure-status-incomplete px-5" [class.count-margin]="!relation.sfiCompleted && !isEditMode" [class.mt-5]="isShowCollapsedConflictRelationship"
                                                                     *ngIf="relation.sfiCompleted == false"><mat-icon class="in-complete-icon">not_interested</mat-icon><span
                                                                    class="notComplete">Incomplete</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mx-3">
                                <app-SFI-conflict-relationship [(isSavingRelation)]="coiService.isRelationshipSaving" [coiStatusList]="coiStatusList" [isEditMode]="isEditMode" *ngIf="isShowCollapsedConflictRelationship && entityProjectDetails?.length" [entityProjectDetails]="entityProjectDetails"
                                                               [coiStatusCode]="coiStatusCode" [coiData]="coiData" [moduleCode]="moduleCode" [selectedProject]="relation" (closePage)="closePage()"></app-SFI-conflict-relationship>
                            </div>
                        </div>
                    </ng-container>
                </div>
                <div *ngIf="!searchResult.length">
                    <app-no-information> </app-no-information>
                </div>
            </ng-container>

        </ng-container>
    </ng-container>

    <app-define-sfi-project *ngIf="switchRelationView"
                            [isEditMode]="isEditMode"
                            [coiStatusList]="coiStatusList"
                            [disclosureId]="coiData?.coiDisclosure?.disclosureId"
                            [coiData]="coiData"
                            [disclosureStatusCode]="coiData?.coiDisclosure?.disclosureStatusCode"
                            (conflictStatusChanged)="updateConflictStatus()"
    ></app-define-sfi-project>

  <app-define-relation *ngIf="isShowRelation" [coiStatusList]="coiStatusList" [moduleCode]="moduleCode"
      [moduleItemId]="moduleId" [module]="selectedProject" (closePage)="closePage()" [relationList]="awardList" [currentRelation]="currentRelation"></app-define-relation>


  <button type="button" class="btn btn-primary btn-sm" hidden=true id="module-view-modal-button" data-bs-toggle="modal"
      data-bs-target="#moduleViewModal"></button>
  <div class="modal fade" id="moduleViewModal" tabindex="-1" aria-labelledby="moduleViewModal" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title">
                    Details of
                    <strong title="{{ selectedProjectForView?.title }}">
                        #{{selectedProjectForView?.moduleCode == 3 ? selectedProjectForView?.moduleItemId : selectedProjectForView?.moduleItemKey}} -
                        {{ (selectedProjectForView?.title)?.length > 80 ? (selectedProjectForView?.title | slice:0: 80)+'...' :
                        selectedProjectForView?.title }}
                    </strong>
                </h4>
                  <button title="Click to close the popup" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <div class="row mx-0 mt-3">
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Principal Investigator</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.principalInvestigator">
                              <span class="grey-text m-0">{{selectedProjectForView?.principalInvestigator}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Project Role</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.reporterRole">
                              <span class="grey-text m-0">{{selectedProjectForView?.reporterRole}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Period</label>
                          <span class="grey-text m-0">
                              {{selectedProjectForView?.startDate | dateFormatter}} - {{selectedProjectForView?.endDate |
                              dateFormatter}}</span>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">{{selectedProjectForView?.moduleCode == 3 ? 'Proposal' :
                              'Award'}} Status</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.moduleStatus">
                              <span class="grey-text m-0">{{selectedProjectForView?.moduleStatus}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Sponsor</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.sponsor">
                              <span class="grey-text m-0">{{selectedProjectForView?.sponsor}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Prime Sponsor</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.primeSponsor">
                              <span class="grey-text m-0">{{selectedProjectForView?.primeSponsor}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-12 mb-3">
                          <label class="d-block label-text">Lead Unit</label>
                          <span class="grey-text m-0">
                            {{_commonService.getPersonLeadUnitDetails(selectedProjectForView)}}</span>
                      </div>
                  </div>
              </div>
              <div class="modal-footer">
                  <button title="Click to close the popup" type="button" (click)="selectedProjectForView= null"
                      class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" title="Click to view project details page"
                      (click)="openProjectMoreDetails(selectedProjectForView.moduleItemId, selectedProjectForView.moduleCode);selectedProjectForView= null;"
                      class="btn btn-primary fs-14" data-bs-dismiss="modal">More Details</button>
              </div>
          </div>
      </div>
  </div>
