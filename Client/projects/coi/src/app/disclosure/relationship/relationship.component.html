<div class="row fs-14 my-2 mx-0 px-3 py-2 alert alert-primary">
    <div class="col align-self-center p-0">
        <ng-container *ngIf="!switchRelationView">For defining SFI against project use 'SFI - Project Relationship'</ng-container>
        <ng-container *ngIf="switchRelationView">For defining project against SFI use 'Project - SFI Relationship'</ng-container>.
    </div>
    <div class="col-auto p-0">
        <button class="btn btn-primary fs-14" (click)="switchRelationViewMode(!switchRelationView)"
        [attr.aria-label]="switchRelationView?'Click here to view Project - SFI Relationship':' Click here to view SFI - Project Relationship'"
        [title]="switchRelationView?'Click here to view Project - SFI Relationship':' Click here to view SFI - Project Relationship'"
        id="btn-view-Relationship">{{switchRelationView?'Project - SFI Relationship':'SFI - Project Relationship'}}</button>
    </div>
</div>

<div *ngIf="isEditMode" class="row align-items-end">
    <div class="col-12">
        <div class="d-flex alert alert-primary mb-0 py-2">
            <mat-icon role="img" class="mat-icon info-icon material-icons flex-shrink-0" aria-hidden="true"
                data-mat-icon-type="font">info</mat-icon>
            <p class="fs-14 mb-0 ms-2">
                <span class="d-flex algin-items-start">
                    <mat-icon class="fs-14 mt-1 me-1 flex-shrink-0">keyboard_double_arrow_right</mat-icon>
                    <span>Projects will be displayed against your
                        Active SFIs, allowing you to mark the relevant conflict status and provide a supporting
                        description for
                        your decision.
                        <span *ngIf="!expandInfo" (click)="expandInfo = true" (keydown.enter)="expandInfo = true" class="fw-700 link-primary" aria-label="Expand Relationship help text" tabindex="0" role="link">...<span
                            id="link-read-more-info" title="Expand Relationship help text" class="fw-700">Read More</span></span>
                    </span>
                </span>
                <ng-container *ngIf="expandInfo">
                    <span class="d-flex algin-items-start mt-2">
                        <mat-icon class="fs-14 mt-1 me-1 flex-shrink-0">keyboard_double_arrow_right</mat-icon>If any of the active SFIs are
                        missing
                        ,please cross-check and make necessary corrections to the SFI list in the SFI section.
                    </span>
                    <span class="d-flex algin-items-start mt-2">
                        <mat-icon class="fs-14 mt-1 me-1 flex-shrink-0">keyboard_double_arrow_right</mat-icon>
                        <span>
                            Before proceeding to the next
                            step,
                            ensure that all your Project-SFI relationships have been marked.
                            <span *ngIf="expandInfo && !isShowCollapsedConflictRelationship"
                                (click)="expandInfo = false" (keydown.enter)="expandInfo = false" class="fw-700 link-primary" tabindex="0" role="link" id="link-read-less-info"
                                title="Collapse Relationship help text" aria-label="Collapse Relationship help text">Read Less</span>
                        </span>
                    </span>
                    <ng-container *ngIf="isShowCollapsedConflictRelationship">
                        <span class="d-flex algin-items-start mt-2">
                            <mat-icon class="fs-14 mt-1 me-1 flex-shrink-0">keyboard_double_arrow_right</mat-icon>For marking all your SFI
                            conflict
                            status/ relationship description use "Apply and Save".
                        </span>
                        <span class="d-flex algin-items-start mt-2">
                            <mat-icon class="fs-14 mt-1 me-1 flex-shrink-0">keyboard_double_arrow_right</mat-icon>
                            <span>
                                For marking individual SFI
                                conflict
                                status/ relationship description use "Save".
                                <span *ngIf="expandInfo" (click)="expandInfo = false" (keydown.enter)="expandInfo = false" class="fw-700 link-primary"><span tabindex="0" role="link" id="link-read-less-info"
                                        title="Collapse Relationship help text" aria-label="Collapse Relationship help text">Read Less</span></span>
                            </span>
                        </span>
                    </ng-container>
                </ng-container>
            </p>
        </div>
    </div>
</div>


  <div class="d-flex align-items-center form-control col-lg-12 col-md-12 col-12 mx-auto mt-2 px-3 rounded py-2" *ngIf="projectList.length>1 && !switchRelationView">
    <mat-icon *ngIf="!searchText" class="mat-icon material-icons search-icon" aria-hidden="true" data-mat-icon-type="font">search</mat-icon>
    <input type="text" placeholder="Search by Project Id, Project Name, PI, Sponsor, Prime Sponsor  "
    class="searchField ms-2" [(ngModel)]="searchText">

  </div>

    <ng-container *ngIf="!switchRelationView">
        <ng-container
            *ngIf="(projectList| SearchFilter : searchText:
  ['title', 'moduleItemId', 'moduleItemKey', 'principalInvestigator', 'sponsor', 'primeSponsor']) as projects; let i = index">
            <ng-container *ngIf="isShowNoDataCard">
                <div *ngIf="projects.length">
                    <ng-container *ngFor="let project of projects;let i = index">
                        <div class="card mt-2 shadow-medium py-1" [id]="project.projectId">
                            <div class="card-body mb-2">
                                <div class="row">
                                    <div class="col-12 mb-3">

                                        <div class="d-flex">
                                            <span class="active-ribbon shadow-sm align-items-center d-flex text-nowrap" [style.background-color]="project?.projectBadgeColour"
                                                aria-label="proposal">{{project?.projectType}}</span>
                                            <span>
                                                <span title="Click to view project details" class="fs-6 link-primary fw-600"
                                                    aria-label="'Click to view project details'" id="link-{{project?.projectId}}"
                                                    (click)="selectedProjectForView=project;"  data-bs-toggle="modal" data-bs-target="#moduleViewModal"
                                                    [attr.aria-label]="project?.projectNumber + '_' + project?.title ">#{{project?.projectNumber}}
                                                    -
                                                    {{project?.title?.length >
                                                    75 && !collapseViewMore[project?.projectId] ? (project?.title | slice:0:75) :
                                                        project?.title}}
                                                </span>
                                                <span (click)="collapseViewMoreOption(project?.projectId, collapseViewMore[project?.projectId])"
                                                    *ngIf="project?.title?.length > 75" tabindex="0" role="link"  id="link-read-more-less"
                                                    aria-label="Click here to {{collapseViewMore[project?.projectId] ? ' Read Less' : ' Read More'}}" title="Click here to {{collapseViewMore[project?.projectId] ? ' Read less' : ' Read more'}}"
                                                    class="fs-14 fw-medium link-primary">
                                                    {{collapseViewMore[project?.projectId] ? "Read Less" : "...Read More"}}</span>
                                            </span>
                                        </div>

                                    </div>
                                    <div class="d-xl-flex px-3">
                                        <div class="col-md-12 col-xl-8">
                                            <div class="row">
                                                <div class="col-md-6 col-lg-4 mb-2">
                                                    <label class="coi-text-dark d-block" for="coi-relationship-pi-{{i}}">Principal Investigator</label>
                                                    <span class="coi-text-light" id="coi-relationship-pi-{{i}}">{{project?.piName}}</span>
                                                </div>
                                                <div class="col-md-6 col-lg-4 mb-2">
                                                    <label class="coi-text-dark d-block" for="coi-relationship-role-{{i}}">Project Role</label>
                                                    <span class="coi-text-light" id="coi-relationship-role-{{i}}">{{project?.reporterRole}}</span>
                                                </div>
                                                <div class="col-md-6 col-lg-4 mb-2">
                                                    <label class="coi-text-dark d-block" for="coi-relationship-period-{{i}}">Period</label>
                                                    <span class="coi-text-light" id="coi-relationship-period-{{i}}">{{project?.projectStartDate | dateFormatter}} - {{project?.projectEndDate |
                                                        dateFormatter}}</span>
                                                </div>
                                                <div class="col-md-6 col-lg-4 mb-2">
                                                    <label class="coi-text-dark d-block" for="coi-relationship-sponsor-{{i}}">Sponsor</label>
                                                    <span class="coi-text-light"  id="coi-relationship-sponsor-{{i}}">{{project?.sponsorName}}</span>
                                                </div>
                                                <div class="col-md-6 col-lg-4 mb-2">
                                                    <label class="coi-text-dark d-block" for="coi-relationship-unit-{{i}}">Lead Unit</label>
                                                    <app-no-data-label [valueToShow]="project?.homeUnitName">
                                                        <span
                                                            class="coi-text-light"  id="coi-relationship-unit-{{i}}">{{_commonService.getPersonLeadUnitDetails(project)}}</span>
                                                    </app-no-data-label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12 col-xl-4">
                                            <div class="border h-100 p-3 position-relative rounded-1 table-bg-color mt-md-3 mt-xl-0">
                                                <span class="status-pill fs-13">Project/SFI Relationship</span>
                                                <div *ngIf="!project.relationShipExists" class="d-flex justify-content-center align-items-center h-100">
                                                    <p class="fw-600 mb-0 text-gray-600">No SFI(s) Attached</p>
                                                </div>
                                                <div *ngIf="project.relationShipExists" class="row">
                                                    <div class="col-6 fs-14">
                                                        <div class="gap-1 row">
                                                            <div class="d-flex align-items-center col-12"
                                                                [attr.aria-label]="'No Conflict count: ' + getDisclosureCount(1, project.disclosureStatusCount)">
                                                                <label class="count-label" for="">No Conflict : </label>
                                                                <span class="fs-12"
                                                                    [ngClass]="{'badge rounded-pill text-no-conflict-badge':project.sfiCompleted != null}">
                                                                    {{project.sfiCompleted != null? getDisclosureCount(1,
                                                                    project.disclosureStatusCount) : '--'}}</span>
                                                            </div>
                                                            <div class="d-flex align-items-center col-12"
                                                                [attr.aria-label]="'Potential Conflict count: ' + getDisclosureCount(2, project.disclosureStatusCount)">
                                                                <label class="count-label" for="">Potential Conflict :</label>
                                                                <span class="fs-12"
                                                                    [ngClass]="{'badge rounded-pill text-potential-conflict-badge':project.sfiCompleted != null}">
                                                                    {{project.sfiCompleted != null ?
                                                                    getDisclosureCount(2,project.disclosureStatusCount):' --'}}</span>
                                                            </div>
                                                            <div class="d-flex align-items-center col-12"
                                                                [attr.aria-label]="'Conflict Identified count: ' + getDisclosureCount(3, project.disclosureStatusCount)">
                                                                <label class="count-label" for="">Conflict Identified :</label>
                                                                <span class="fs-12"
                                                                    [ngClass]="{'badge rounded-pill text-conflict-badge':project.sfiCompleted != null}">
                                                                    {{ project.sfiCompleted !=
                                                                    null?getDisclosureCount(3,project.disclosureStatusCount): '--'}}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center justify-content-center col-6">
                                                        <div class="row">
                                                            <div *ngIf="!isShowCollapsedConflictRelationship"
                                                                class="d-flex justify-content-center col-12">
                                                                <button title="Click to {{isEditMode ? 'Define' : 'Manage'}} Project - SFI relationship"
                                                                    [attr.aria.label]="'Click to '+ isEditMode ? 'Define' : 'Manage' +' Project - SFI relationship'" id="btn-define-relationship-{{i}}"
                                                                    class="align-items-center btn btn-primary d-flex fs-14 text-nowrap"
                                                                    (click)="openDefineRelationship(project, i)" type="submit">
                                                                    <img src="{{deployMap}}assets/images/define-relation-hover.svg"
                                                                        class="mr-2 hover_img"
                                                                        alt="{{isEditMode ? 'Define Relationship' : 'Manage Relationship'}}">{{isEditMode
                                                                    ? 'Define Relationship' : 'Manage Relationship'}}
                                                                </button>
                                                            </div>
                                                            <div class="d-flex justify-content-center col-12"
                                                                [class.mt-1]="!isShowCollapsedConflictRelationship">
                                                                <div *ngIf="project.sfiCompleted == true" class="d-flex fs-14 text-success">
                                                                    <mat-icon class="fs-18 me-1">done</mat-icon><span class="">Completed</span>
                                                                </div>
                                                                <div *ngIf="project.sfiCompleted == false" class="d-flex fs-14 text-danger">
                                                                    <mat-icon class="fs-18 me-1">not_interested</mat-icon><span
                                                                        class="">Incomplete</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mx-3">
                                <app-SFI-conflict-relationship [(isSavingRelation)]="coiService.isRelationshipSaving"
                                    [coiStatusList]="coiStatusList" [isEditMode]="isEditMode"
                                    *ngIf="isShowCollapsedConflictRelationship && entityProjectDetails?.length"
                                    [entityProjectDetails]="entityProjectDetails" [coiStatusCode]="coiStatusCode" [coiData]="coiData"
                                    [moduleCode]="moduleCode" [selectedProject]="project"
                                    (closePage)="closePage()"></app-SFI-conflict-relationship>
                            </div>
                        </div>
                    </ng-container>
                </div>
                <div *ngIf="!projects.length">
                    <app-no-information> </app-no-information>
                </div>
            </ng-container>

        </ng-container>
    </ng-container>

    <app-define-sfi-project *ngIf="switchRelationView"
                            [isEditMode]="isEditMode"
                            [coiStatusList]="coiStatusList"
                            [disclosureId]="coiData?.coiDisclosure?.disclosureId"
                            [coiData]="coiData"
                            [disclosureStatusCode]="coiData?.coiDisclosure?.disclosureStatusCode"
                            (conflictStatusChanged)="updateConflictStatus()"
    ></app-define-sfi-project>

  <app-define-relation *ngIf="isShowRelation" [coiStatusList]="coiStatusList" [moduleCode]="moduleCode"
      [moduleItemId]="moduleId" [module]="selectedProject" (closePage)="closePage()" [relationList]="projectList" [currentRelation]="currentRelation"></app-define-relation>


  <button type="button" class="btn btn-primary btn-sm" hidden=true id="module-view-modal-button" data-bs-toggle="modal"
      data-bs-target="#moduleViewModal"></button>
  <div class="modal fade" id="moduleViewModal" tabindex="-1" aria-labelledby="moduleViewModal" aria-hidden="true"  data-bs-backdrop="static">
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
          <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title">
                    Details of
                    <strong title="{{ selectedProjectForView?.title }}">
                        #{{selectedProjectForView?.projectNumber}} -
                        {{ (selectedProjectForView?.title)?.length > 80 ? (selectedProjectForView?.title | slice:0: 80)+'...' :
                        selectedProjectForView?.title }}
                    </strong>
                </h4>
                  <button title="Click to close the popup" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Click to close" aria-label="Click to close the popup" tabindex="0"></button>
              </div>
              <div class="modal-body">
                  <div class="row mx-0 mt-3">
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Principal Investigator</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.piName">
                              <span class="grey-text m-0">{{selectedProjectForView?.piName}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Project Role</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.reporterRole">
                              <span class="grey-text m-0">{{selectedProjectForView?.reporterRole}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Period</label>
                          <span class="grey-text m-0">
                              {{selectedProjectForView?.projectStartDate | dateFormatter}} - {{selectedProjectForView?.projectEndDate |
                              dateFormatter}}</span>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">{{selectedProjectForView?.projectType}} Status</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.projectStatus">
                              <span class="grey-text m-0">{{selectedProjectForView?.projectStatus}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Sponsor</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.sponsorName">
                              <span class="grey-text m-0">{{selectedProjectForView?.sponsorName}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-6 mb-3">
                          <label class="d-block label-text">Prime Sponsor</label>
                          <app-no-data-label [valueToShow]="selectedProjectForView?.primeSponsorName">
                              <span class="grey-text m-0">{{selectedProjectForView?.primeSponsorName}}</span>
                          </app-no-data-label>
                      </div>
                      <div class="col-lg-4 col-sm-6 col-12 mb-3">
                          <label class="d-block label-text">Lead Unit</label>
                          <span class="grey-text m-0">
                            {{_commonService.getPersonLeadUnitDetails(selectedProjectForView)}}</span>
                      </div>
                  </div>
              </div>
              <div class="modal-footer">
                  <button title="Click to close the popup" type="button" (click)="selectedProjectForView= null" aria-label="Click to close the popup"
                  id="btn-close"
                      class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" title="Click to view project details page" aria-label="Click to view project details page" id="btn-more-details"
                      (click)="coiService.openProjectMoreDetails(selectedProjectForView.projectId, selectedProjectForView.projectTypeCode);selectedProjectForView= null;"
                      class="btn btn-primary fs-14" data-bs-dismiss="modal">More Details</button>
              </div>
          </div>
      </div>
  </div>
