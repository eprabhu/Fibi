<div *ngIf="selectedProject?.moduleCode" [id]="'coi-card-' + selectedProject?.projectId" class="card coi-card-regular border shadow me-2 mt-2 ms-2"
  [ngClass]="{'coi-card-highlight': coiSummaryService.activeSubNavItemId === selectedProject.projectTypeCode+'-'+selectedProject?.projectId}">
    <div class="card-header px-4 py-2 d-flex align-items-center justify-content-between border-bottom-0 flex-nowrap">
      <span class="d-flex align-items-center">
          <span class="active-ribbon shadow-sm align-items-center d-flex text-nowrap me-2" [ngStyle]="{'background-color': selectedProject.projectBadgeColour}">{{selectedProject?.projectType}}</span>
          <span class="d-inline-flex">
            <mat-icon *ngIf="selectedProject?.moduleCode != 1" aria-hidden="true" class="coi-text-light flex-shrink-0">article</mat-icon>
            <mat-icon *ngIf="selectedProject?.moduleCode == 1" aria-hidden="true" class="coi-text-light flex-shrink-0">workspace_premium</mat-icon>
            <a tabindex="0" class="fs-6 link-primary fw-600 text-slice" id="link-{{selectedProject?.projectId}}"
                title="Click here to view project details of #{{selectedProject?.projectNumber}} - {{selectedProject?.title}}"
                attr.aria-label="Click here to view project details of {{selectedProject?.projectNumber}} - {{selectedProject?.title}}"
                (click)="openModule()" (keyup.enter)="openModule()" (keyup.space)="openModule()" data-bs-toggle="modal" data-bs-target="#moduleViewModal">
                #{{selectedProject?.projectNumber}}- {{selectedProject?.title}}
            </a>
        </span>
      </span>
      <div class="col-auto d-flex align-items-center ms-3">
        <!-- Conflict Status -->
        <div *ngIf="projectRelations.length > 0 && projectRelations[0]?.coiEntity?.entityName != null" class="me-2">
            <label for="coi-relationship-conflict-status" class="coi-text-light me-2 fw-500 d-block d-lg-inline">Conflict Status:</label>
            <span class="{{_commonService.getProjectDisclosureConflictStatusBadge(worstCaseStatus?.projectConflictStatusCode)}}"></span>
            <span class="badgeFont" id="coi-relationship-conflict-status">{{worstCaseStatus?.description}}</span>
        </div>
        <p *ngIf="projectRelations.length == 0" class="f-14 fw-500 m-0 pe-2">No SFI(s) Attached</p>
        <!-- comments -->
        <button (click)="openReviewerComment(selectedProject,'RELATIONSHIP')" class="btn btn-primary-icon btn-sm d-flex mt-1" id="add-activity"
          title="Click here to open comments" aria-label="Click here to open comments" type="button">
          <mat-icon aria-hidden="true" class="flex-shrink-0">rate_review</mat-icon>
        </button>
      </div>
    </div>
    <div *ngIf="isCollapsed" class="card-body" id="coi-relationship">
      <div class="row mb-2">
        <!-- Principal Investigator -->
        <div tabindex="-1" class="col-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3 mb-2"
            [attr.aria-label]="'Principal investigator is ' + (selectedProject?.piName ? selectedProject?.piName : 'empty')">
            <label for="coi-relationship-pi-{{selectedProject?.moduleCode}}" class="coi-text-dark d-block">Principal Investigator</label>
            <div id="coi-relationship-pi-{{selectedProject?.moduleCode}}" class="text-slice">
                <app-no-data-label [valueToShow]="selectedProject?.piName">
                    <span class="coi-text-light" [title]="selectedProject?.piName">{{selectedProject?.piName}}</span>
                </app-no-data-label>
            </div>
        </div>
        <!-- Reporter's Project Role -->
        <div tabindex="-1" class="col-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3 mb-2"
            [attr.aria-label]="'Reporters project role is ' + (selectedProject?.reporterRole ? selectedProject?.reporterRole : 'empty')">
            <label for="coi-relationship-role-{{selectedProject?.moduleCode}}" class="coi-text-dark d-block">Reporter's Project Role</label>
            <div id="coi-relationship-role-{{selectedProject?.moduleCode}}" class="text-slice">
                <app-no-data-label [valueToShow]="selectedProject?.reporterRole">
                    <span class="coi-text-light" [title]="selectedProject?.reporterRole">{{selectedProject?.reporterRole}}</span>
                </app-no-data-label>
            </div>
        </div>
        <!-- Period -->
        <div tabindex="-1" class="col-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3 mb-2"
            [attr.aria-label]="'Period is ' + ((selectedProject?.projectStartDate || selectedProject?.projectEndDate) ?
            ((selectedProject?.projectStartDate | dateFormatter) + ' - ' + (selectedProject?.projectEndDate | dateFormatter))  : 'empty')">
            <label for="coi-relationship-period-{{selectedProject?.moduleCode}}" class="coi-text-dark d-block">Period</label>
            <div id="coi-relationship-period-{{selectedProject?.moduleCode}}" class="text-slice">
                <app-no-data-label [valueToShow]="selectedProject?.projectStartDate || selectedProject?.projectEndDate">
                    <span [title]="(selectedProject?.projectStartDate | dateFormatter) + ' - ' + (selectedProject?.projectEndDate | dateFormatter)"
                        class="coi-text-light">{{selectedProject?.projectStartDate | dateFormatter}} - {{selectedProject?.projectEndDate | dateFormatter}}</span>
                </app-no-data-label>
            </div>
        </div>
        <!-- Project Status -->
        <div tabindex="-1" class="col-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3 mb-2"
            [attr.aria-label]="'Project status is ' + (selectedProject?.projectStatus ? selectedProject?.projectStatus : 'empty')">
            <label for="coi-relationship-status-{{selectedProject?.moduleCode}}" class="coi-text-dark d-block">Project Status</label>
            <div id="coi-relationship-status-{{selectedProject?.moduleCode}}" class="text-slice">
                <app-no-data-label [valueToShow]="selectedProject?.projectStatus">
                    <span class="coi-text-light" [title]="selectedProject?.projectStatus">{{selectedProject?.projectStatus}}</span>
                </app-no-data-label>
            </div>
        </div>
        <!-- Lead Unit -->
        <div tabindex="-1" class="col-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3 mb-2"
            [attr.aria-label]="'Lead unit is ' + (_commonService.getPersonLeadUnitDetails(selectedProject) ?
            _commonService.getPersonLeadUnitDetails(selectedProject) : 'empty')">
            <label for="coi-relationship-unit-{{selectedProject?.moduleCode}}" class="coi-text-dark d-block">Lead Unit</label>
            <div id="coi-relationship-unit-{{selectedProject?.moduleCode}}" class="text-slice">
                <app-no-data-label [valueToShow]="_commonService.getPersonLeadUnitDetails(selectedProject)">
                    <span [title]="_commonService.getPersonLeadUnitDetails(selectedProject)"
                        class="coi-text-light">{{_commonService.getPersonLeadUnitDetails(selectedProject)}}</span>
                </app-no-data-label>
            </div>
        </div>
        <!-- Sponsor -->
        <div tabindex="-1" class="col-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3 mb-2"
            [attr.aria-label]="'Sponsor is ' + (selectedProject?.sponsorName ? selectedProject?.sponsorName : 'empty')">
            <label for="coi-relationship-sponsor-{{selectedProject?.moduleCode}}" class="coi-text-dark d-block"
                aria-label="Sponsor is, ">Sponsor</label>
            <div id="coi-relationship-sponsor-{{selectedProject?.moduleCode}}" class="text-slice">
                <app-no-data-label [valueToShow]="selectedProject?.sponsorName">
                    <span class="coi-text-light" [title]="selectedProject?.sponsorName">{{selectedProject?.sponsorName}}</span>
                </app-no-data-label>
            </div>
        </div>
        <!-- Prime Sponsor -->
        <div tabindex="-1" class="col-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3 mb-2"
            [attr.aria-label]="'Prime sponsor is ' + (selectedProject?.primeSponsorName ? selectedProject?.primeSponsorName : 'empty')">
            <label for="coi-relationship-prime-sponsor-{{selectedProject?.moduleCode}}" class="coi-text-dark d-block"
                aria-label="Prime sponsor is, ">Prime Sponsor</label>
            <div id="coi-relationship-prime-sponsor-{{selectedProject?.moduleCode}}" class="text-slice">
                <app-no-data-label [valueToShow]="selectedProject?.primeSponsorName">
                    <span class="coi-text-light" [title]="selectedProject?.primeSponsorName">{{selectedProject?.primeSponsorName}}</span>
                </app-no-data-label>
            </div>
        </div>
    </div>
      <div class="table-responsive coi-table-striped">
      <table class="table table-bordered fs-14 fw-medium table-striped" *ngIf="projectRelations.length > 0  && projectRelations[0]?.coiEntity?.entityName != null" id="coi-relationship-summary-table">
                <!-- <caption class="sr-only">List of Awards/Proposal</caption> -->
                <thead>
                    <tr class="header-border table-light" id="coi-relationship-summary-table-thead">
                      <th style="width: 40%;" class="px-3">Significant Financial Interest</th>
                      <th style="width: 26%;" class="px-3">Relationship between SFIs and Projects</th>
                        <th style="width: 14%;" class="px-3">Conflict Status
                            <button title="Sort conflict Status in ascending order" class="sortable-icon btn p-0"
                                    aria-label="click to sort conflict Status"
                                    *ngIf="isDesc" (click)="sortConflictStatus(true)">
                                <mat-icon>arrow_upward</mat-icon>
                            </button>
                            <button title="Sort conflict Status in descending order" class="sortable-icon btn p-0"
                                    *ngIf="!isDesc" (click)="sortConflictStatus(false)">
                                <mat-icon>arrow_downward</mat-icon>
                            </button>
                        </th>
                      <th style="width: 8%;" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="white-bg">
                  <tr *ngFor="let relation of projectRelations; let i = index" class="tr-hover" id="{{relation.disclosureDetailsId}}">
                    <td class="table-data fw-600 px-3">
                        <div class="mb-2 py-1">
                          <a class="link-primary text-slice" (click)="openEntityDetails(relation?.personEntityRelationshipDto?.personEntityId)"
                            (keydown.enter)="openEntityDetails(relation?.personEntityRelationshipDto?.personEntityId)"
                            tabindex="0" attr.aria-label="Click here to view SFI details of {{relation?.coiEntity?.entityName}}" role="link"
                            title="Click here to view SFI details of '{{relation?.coiEntity?.entityName}}'">
                            {{relation?.coiEntity?.entityName}}
                          </a>
                        </div>
                        <div class="d-flex flex-wrap fw-medium fs-13 gap-2">
                            <ng-container *ngFor="let relation of getEntityRelationTypePills(relation?.personEntityRelationshipDto?.validPersonEntityRelType)">
                              <span class="relationship-pill border px-3 py-1 rounded-4 d-inline-block">
                                <span class="d-flex coi-purple-text">
                                    <mat-icon aria-hidden="true"
                                    class="flex-shrink-0 me-1">{{getIcon(relation?.relationshipType)}}</mat-icon>
                                    <span class="fw-bold me-1">{{relation?.relationshipType}}:</span>
                                    <span class="fw-normal">{{relation?.description}}</span>
                                </span>
                              </span>
                            </ng-container>
                        </div>
                        <div class="row mt-2 fw-medium fs-13">
                            <span class="d-flex align-items-center">
                                <span class="fs-13 me-3">
                                    <span>Country:</span>&nbsp;{{relation?.personEntityRelationshipDto?.countryName}}</span>
                                <span class="fs-13"> <span>Type:</span> &nbsp;{{relation?.personEntityRelationshipDto?.entityType}}
                                </span>
                            </span>
                        </div>
                    </td>
                    <td class="px-3">
                      <div class="person-card fs-13 grey-text word-break-all new-line-property">
                        <span *ngIf="!isReadMore[i] && relation?.disclComment?.comment?.length > 60; else showFullInfo">
                          <span> {{(relation?.disclComment?.comment | slice:0:60)}}</span>
                          <span (click)="isReadMore[i] = !isReadMore[i]" tabindex="0" (keydown.enter)="isReadMore[i] = !isReadMore[i]" role="link"
                            aria-label="Click here Read more" title="Click here Read more" class="link-primary">...Read more
                          </span>
                        </span>
                        <ng-template #showFullInfo>
                          <span>{{relation?.disclComment?.comment}}</span>
                          <span *ngIf="relation?.disclComment?.comment?.length > 60" (click)="isReadMore[i] = !isReadMore[i]"
                            (keydown.enter)="isReadMore[i] = !isReadMore[i]" tabindex="0" role="link" aria-label="Click here Read less"
                            title="Click here Read less" class="link-primary ms-1">Read Less
                          </span>
                        </ng-template>
                      </div>
                    </td>
                    <td class="px-3 text-nowrap">
                      <span class="{{_commonService.getProjectDisclosureConflictStatusBadge(relation?.coiProjConflictStatusType?.projectConflictStatusCode)}}"></span>
                      <span>
                        {{relation?.coiProjConflictStatusType?.description}}
                    </span>
                    </td>
                    <td class="pt-4 px-3">
                      <div class="d-flex">
                        <!-- reviewStatusCode-(3-Review In Progress, 7-Review Assigned, 8-Assigned review completed, 4-completed),  dispositionStatusCode(1-pending, 3-Approved)-->
                        <button *ngIf="(['3', '7', '8'].includes(coiDetails?.reviewStatusCode) && coiDetails?.dispositionStatusCode == 1) || (coiDetails?.reviewStatusCode== 4 && coiDetails?.dispositionStatusCode == 3)
                        && (_commonService.getCurrentUserDetail('userName') == coiDetails?.createUser || _commonService.getCurrentUserDetail('personId') == coiDetails?.adminPersonId)"
                        class="btn-primary-icon-svg me-1" type="button" (mouseenter)="isShowHoverWhite[i]= true"
                        (mouseout)="isShowHoverWhite[i]= false" (click)="isOpenSlider = true; setEntityDetails(relation, i);">
                        <span class="btn-secondary-svg"></span>
                      </button>
                      <button (click)="openReviewerComment(selectedProject,'SFI', relation)" class="add-activity-button comment-style align-items-center btn btn-primary-icon btn-sm d-flex p-0 px-2" id="add-activity" title="Comments" type="button">
                        <mat-icon>rate_review</mat-icon>
                      </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
      </div>
              <div *ngIf="!projectRelations.length  || projectRelations[0]?.coiEntity?.entityName == null">
                <app-no-information> </app-no-information>
              </div>
      </div>
</div>
<app-add-conflict-slider *ngIf="isOpenSlider" (closePage)="closePage($event)" [isOpenSlider]="isOpenSlider" [disclosureMetaData]="{coiPersonFullName: coiDetails?.person?.fullName}"
  [entityDetails]="entityDetails" [isEditMode]="['3','7','8'].includes(coiDetails?.reviewStatusCode) && coiDetails?.dispositionStatusCode == 1 && (_commonService.getCurrentUserDetail('personId') == coiDetails?.adminPersonId)"></app-add-conflict-slider>

