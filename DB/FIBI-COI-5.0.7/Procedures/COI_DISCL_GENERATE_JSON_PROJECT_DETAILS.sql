DELIMITER //
CREATE PROCEDURE `COI_DISCL_GENERATE_JSON_PROJECT_SNAPSHOT`(
	AV_DISCLOSURE_ID		INT,
	AV_PERSON_ID			VARCHAR(40)
)
BEGIN

DECLARE LS_MODULE_CODE				VARCHAR(10);
DECLARE LS_MODULE_ITEM_KEY			VARCHAR(45);
DECLARE LI_COI_DISCL_PROJECTS_ID	INT;
DECLARE PROJECT_JSON 				JSON;

DECLARE done INT DEFAULT 0;

	DECLARE project_cur CURSOR FOR SELECT COI_DISCL_PROJECTS_ID, MODULE_CODE, MODULE_ITEM_KEY FROM COI_DISCL_PROJECTS
	WHERE DISCLOSURE_ID = AV_DISCLOSURE_ID;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
	OPEN project_cur;
	read_loop: LOOP
        FETCH project_cur INTO LI_COI_DISCL_PROJECTS_ID, LS_MODULE_CODE, LS_MODULE_ITEM_KEY;

        IF done THEN
            LEAVE read_loop;
        END IF;

		IF LS_MODULE_CODE = '1' THEN
			SELECT JSON_OBJECT(
				'PROJECT_ID', EXTERNAL_SYSTEM_REF_ID,
				'COI_PROJECT_TYPE_CODE',COI_PROJECT_TYPE_CODE,
				'PROJECT_NUMBER', AWARD_NUMBER,
				'ACCOUNT_NUMBER', ACCOUNT_NUMBER,
				'PROJECT_TITLE', TITLE,
				'PI_PERSON_ID', PI_PERSON_ID,
				'PI_NAME', PI_NAME,
				'PROJECT_STATUS', AWARD_STATUS,
				'PROJECT_STATUS_CODE', AWARD_STATUS_CODE,
				'SPONSOR_NAME', SPONSOR_NAME,
				'SPONSOR_CODE', SPONSOR_CODE,
				'PRIME_SPONSOR_NAME', PRIME_SPONSOR_NAME,
				'PRIME_SPONSOR_CODE', PRIME_SPONSOR_CODE,
				'PROJECT_START_DATE', AWARD_START_DATE,
				'PROJECT_END_DATE', AWARD_END_DATE,
				'LEAD_UNIT_NUMBER', LEAD_UNIT_NUMBER,
				'LEAD_UNIT_NAME', LEAD_UNIT_NAME,
				'KEY_PERSON_NAME', KEY_PERSON_NAME,
				'KEY_PERSON_ID', KEY_PERSON_ID,
				'KEY_PERSON_ROLE_NAME', KEY_PERSON_ROLE_NAME
			) INTO PROJECT_JSON
			FROM COI_PROJECT_AWARD_V WHERE AWARD_NUMBER = LS_MODULE_ITEM_KEY AND KEY_PERSON_ID = AV_PERSON_ID;

		ELSEIF LS_MODULE_CODE = '2' THEN
			SELECT JSON_OBJECT(
				'PROJECT_ID', EXTERNAL_SYSTEM_REF_ID,
				'COI_PROJECT_TYPE_CODE',COI_PROJECT_TYPE_CODE,
				'PROJECT_NUMBER', PROPOSAL_NUMBER,
				'PROJECT_TITLE', TITLE,
				'PI_PERSON_ID', PI_PERSON_ID,
				'PI_NAME', PI_NAME,
				'PROJECT_STATUS', PROPOSAL_STATUS,
				'PROJECT_STATUS_CODE', PROPOSAL_STATUS_CODE,
				'SPONSOR_NAME', SPONSOR_NAME,
				'SPONSOR_CODE', SPONSOR_CODE,
				'PRIME_SPONSOR_NAME', PRIME_SPONSOR_NAME,
				'PRIME_SPONSOR_CODE', PRIME_SPONSOR_CODE,
				'PROJECT_START_DATE', PROPOSAL_START_DATE,
				'PROJECT_END_DATE', PROPOSAL_END_DATE,
				'LEAD_UNIT_NUMBER', LEAD_UNIT_NUMBER,
				'LEAD_UNIT_NAME', LEAD_UNIT_NAME,
				'KEY_PERSON_NAME', KEY_PERSON_NAME,
				'KEY_PERSON_ID', KEY_PERSON_ID,
				'KEY_PERSON_ROLE_NAME', KEY_PERSON_ROLE_NAME
			) INTO PROJECT_JSON
			FROM COI_PROJECT_INSTITUTE_PROPOSAL_V WHERE PROPOSAL_NUMBER = LS_MODULE_ITEM_KEY AND KEY_PERSON_ID = AV_PERSON_ID;

		ELSE
			SELECT JSON_OBJECT(
				'PROJECT_ID', EXTERNAL_SYSTEM_REF_ID,
				'COI_PROJECT_TYPE_CODE',COI_PROJECT_TYPE_CODE,
				'PROJECT_NUMBER', PROPOSAL_NUMBER,
				'PROJECT_TITLE', TITLE,
				'PI_PERSON_ID', PI_PERSON_ID,
				'PI_NAME', PI_NAME,
				'PROJECT_STATUS', PROPOSAL_STATUS,
				'PROJECT_STATUS_CODE', PROPOSAL_STATUS_CODE,
				'SPONSOR_NAME', SPONSOR_NAME,
				'SPONSOR_CODE', SPONSOR_CODE,
				'PRIME_SPONSOR_NAME', PRIME_SPONSOR_NAME,
				'PRIME_SPONSOR_CODE', PRIME_SPONSOR_CODE,
				'PROJECT_START_DATE', PROPOSAL_START_DATE,
				'PROJECT_END_DATE', PROPOSAL_END_DATE,
				'LEAD_UNIT_NUMBER', LEAD_UNIT_NUMBER,
				'LEAD_UNIT_NAME', LEAD_UNIT_NAME,
				'KEY_PERSON_NAME', KEY_PERSON_NAME,
				'KEY_PERSON_ID', KEY_PERSON_ID,
				'KEY_PERSON_ROLE_NAME', KEY_PERSON_ROLE_NAME
			) INTO PROJECT_JSON
			FROM COI_PROJECT_PROPOSAL_V WHERE PROPOSAL_NUMBER = LS_MODULE_ITEM_KEY AND KEY_PERSON_ID = AV_PERSON_ID;

		END IF;

		UPDATE COI_DISCL_PROJECTS SET PROJECT_SNAPSHOT = PROJECT_JSON WHERE COI_DISCL_PROJECTS_ID = LI_COI_DISCL_PROJECTS_ID;

	END LOOP;
	CLOSE project_cur;

END

//