DELIMITER //
CREATE PROCEDURE COI_INT_PROP_PERSON_DISCL_STATUS(
    IN AV_PROPOSAL_NUMBER  VARCHAR(20),
    IN AV_KEY_PERSON_ID    VARCHAR(40)
)
SP_BLOCK:BEGIN
    DECLARE LI_COUNT                     INT DEFAULT 0;
    DECLARE LS_DISCLOSURE_REQUIRED_FLAG  VARCHAR(20);
    DECLARE LS_CERTIFICATION_FLAG        VARCHAR(20);
    DECLARE LS_REVIEW_STATUS             VARCHAR(200);
	DECLARE LI_DISCLOSURE_ID             INT DEFAULT NULL;


    SELECT COUNT(1) INTO LI_COUNT
    FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON 
    WHERE PROPOSAL_NUMBER = AV_PROPOSAL_NUMBER
    AND KEY_PERSON_ID = AV_KEY_PERSON_ID;

    IF LI_COUNT = 0 THEN
        SELECT NULL AS DISCLOSURE_ID,NULL AS DISCLOSURE_STATUS;
        LEAVE SP_BLOCK;
    END IF;


    SELECT DISCLOSURE_REQUIRED_FLAG, CERTIFICATION_FLAG 
    INTO LS_DISCLOSURE_REQUIRED_FLAG, LS_CERTIFICATION_FLAG
    FROM COI_INT_STAGE_DEV_PROPOSAL_PERSON 
    WHERE PROPOSAL_NUMBER = AV_PROPOSAL_NUMBER
    AND KEY_PERSON_ID = AV_KEY_PERSON_ID;

    IF LS_DISCLOSURE_REQUIRED_FLAG IS NULL THEN
        SELECT NULL AS DISCLOSURE_ID,'No Data Found.' AS DISCLOSURE_STATUS;
        LEAVE SP_BLOCK;
    END IF;

    IF LS_DISCLOSURE_REQUIRED_FLAG = 'NOT_REQUIRED' THEN
        SELECT NULL AS DISCLOSURE_ID,'Not Required.' AS DISCLOSURE_STATUS;
        LEAVE SP_BLOCK;
    END IF;


    IF LS_CERTIFICATION_FLAG = 'INCOMPLETE' THEN
        SELECT NULL AS DISCLOSURE_ID,'Not Disclosed.' AS DISCLOSURE_STATUS;
        LEAVE SP_BLOCK;
    END IF;

  
			SELECT CD.DISCLOSURE_ID, CRST.DESCRIPTION
			INTO LI_DISCLOSURE_ID,LS_REVIEW_STATUS  
			FROM COI_DISCL_PROJECTS CDP
			INNER JOIN COI_DISCLOSURE CD ON CD.DISCLOSURE_ID = CDP.DISCLOSURE_ID
			INNER JOIN COI_REVIEW_STATUS_TYPE CRST ON CRST.REVIEW_STATUS_CODE = CD.REVIEW_STATUS_CODE
			WHERE CDP.MODULE_CODE = '3'
			  AND CD.FCOI_TYPE_CODE = '2' 
			  AND CDP.MODULE_ITEM_KEY = AV_PROPOSAL_NUMBER
			  AND CD.PERSON_ID =  AV_KEY_PERSON_ID
			  AND CD.DISPOSITION_STATUS_CODE <> 2
			  AND CD.DISCLOSURE_ID = (SELECT MAX(CD2.DISCLOSURE_ID)
									  FROM COI_DISCLOSURE CD2
									  INNER JOIN COI_DISCL_PROJECTS CDP2 ON CDP2.DISCLOSURE_ID = CD2.DISCLOSURE_ID
									  WHERE CDP2.MODULE_CODE = '3'
										AND CD2.FCOI_TYPE_CODE = '2'
										AND CDP2.MODULE_ITEM_KEY = CDP.MODULE_ITEM_KEY
										AND CD2.PERSON_ID = CD.PERSON_ID
										AND CD2.DISPOSITION_STATUS_CODE <> 2);
				
	IF LS_REVIEW_STATUS IS NULL THEN 
		SELECT NULL AS DISCLOSURE_ID,'Not Disclosed.' AS DISCLOSURE_STATUS;
		LEAVE SP_BLOCK;			
	END IF;
	
    IF UPPER(LS_REVIEW_STATUS) = 'PENDING' THEN   
		SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID,'Pending.' AS DISCLOSURE_STATUS;
		LEAVE SP_BLOCK;
	ELSE 
		SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID,'Completed.' AS DISCLOSURE_STATUS;
		LEAVE SP_BLOCK;
    END IF;

END SP_BLOCK;
//
