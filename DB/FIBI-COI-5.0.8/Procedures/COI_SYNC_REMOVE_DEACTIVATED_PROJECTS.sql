DELIMITER //
CREATE PROCEDURE `COI_SYNC_REMOVE_DEACTIVATED_PROJECTS`(
    IN AV_MODULE_CODE INT,
    IN AV_MODULE_ITEM_KEY VARCHAR(100)
)
BEGIN
    DECLARE LS_KEY_PERSON_IDS LONGTEXT;
    DECLARE LI_COI_DISCL_PROJECTS_IDS LONGTEXT;
    -- Fetching the deactivated key persons
   /* IF AV_MODULE_CODE = 1 THEN
		SELECT GROUP_CONCAT(T2.KEY_PERSON_ID) INTO LS_KEY_PERSON_IDS
        FROM COI_INT_STAGE_AWARD T1
		INNER JOIN COI_INT_STAGE_AWARD_PERSON T2 ON T2.PROJECT_NUMBER = T1.PROJECT_NUMBER
		LEFT JOIN COI_INT_STAGE_AWARD T0 ON T0.PROJECT_NUMBER = T1.PROJECT_NUMBER
			AND ((T1.ATTRIBUTE_1_VALUE = 'PC' AND T2.KEY_PERSON_ROLE_CODE IN(1,3))
				OR (T1.ATTRIBUTE_1_VALUE = 'PCK' AND T2.KEY_PERSON_ROLE_CODE IN(1,2,3))
			)
		LEFT JOIN SPONSOR_DISCLOSURE_REQUIREMENTS T3 ON T3.SPONSOR_CODE = T1.SPONSOR_CODE
			AND (T3.KEY_PERSON_DISCL_REQUIREMENT = 'ALL' OR ( T3.KEY_PERSON_DISCL_REQUIREMENT = 'PI-COI' AND T2.KEY_PERSON_ROLE_CODE IN(1,3)))
    	LEFT JOIN SPONSOR_DISCLOSURE_REQUIREMENTS T4 ON T4.SPONSOR_CODE = T1.PRIME_SPONSOR_CODE
			AND (T4.KEY_PERSON_DISCL_REQUIREMENT = 'ALL' OR (T4.KEY_PERSON_DISCL_REQUIREMENT = 'PI-COI' AND T2.KEY_PERSON_ROLE_CODE IN(1,3)))
        WHERE T1.PROJECT_NUMBER = AV_MODULE_ITEM_KEY
		AND (T1.PROJECT_STATUS_CODE NOT IN (1,6,3)
			OR T2.STATUS = 'I'
			OR (T3.KEY_PERSON_DISCL_REQUIREMENT IS NULL AND T4.KEY_PERSON_DISCL_REQUIREMENT IS NULL AND T0.ATTRIBUTE_1_VALUE IS NULL)
		);
*/
    IF AV_MODULE_CODE = 2 THEN
        SELECT GROUP_CONCAT(T2.KEY_PERSON_ID) INTO LS_KEY_PERSON_IDS
        FROM COI_INT_STAGE_PROPOSAL T1
		INNER JOIN COI_INT_STAGE_PROPOSAL_PERSON T2 ON T2.PROJECT_NUMBER = T1.PROJECT_NUMBER
		LEFT JOIN COI_INT_STAGE_PROPOSAL T0 ON T0.PROJECT_NUMBER = T1.PROJECT_NUMBER
			AND ((T1.ATTRIBUTE_1_VALUE = 'PC' AND T2.KEY_PERSON_ROLE_CODE IN(1,3))
				OR (T1.ATTRIBUTE_1_VALUE = 'PCK' AND T2.KEY_PERSON_ROLE_CODE IN(1,2,3))
			)
		LEFT JOIN SPONSOR_DISCLOSURE_REQUIREMENTS T3 ON T3.SPONSOR_CODE = T1.SPONSOR_CODE
			AND (T3.KEY_PERSON_DISCL_REQUIREMENT = 'ALL' OR ( T3.KEY_PERSON_DISCL_REQUIREMENT = 'PI-COI' AND T2.KEY_PERSON_ROLE_CODE IN(1,3)))
    	LEFT JOIN SPONSOR_DISCLOSURE_REQUIREMENTS T4 ON T4.SPONSOR_CODE = T1.PRIME_SPONSOR_CODE
			AND (T4.KEY_PERSON_DISCL_REQUIREMENT = 'ALL' OR (T4.KEY_PERSON_DISCL_REQUIREMENT = 'PI-COI' AND T2.KEY_PERSON_ROLE_CODE IN(1,3)))
        WHERE T1.PROJECT_NUMBER = AV_MODULE_ITEM_KEY AND (T1.PROJECT_STATUS_CODE <> 1
		    OR T2.STATUS = 'I'
		    OR (T3.KEY_PERSON_DISCL_REQUIREMENT IS NULL AND T4.KEY_PERSON_DISCL_REQUIREMENT IS NULL AND T0.ATTRIBUTE_1_VALUE IS NULL)
		);
    END IF;

    -- Delete records if there are deactivated projects
    IF LS_KEY_PERSON_IDS IS NOT NULL AND LS_KEY_PERSON_IDS <>'' THEN

        SELECT GROUP_CONCAT(T1.COI_DISCL_PROJECTS_ID) INTO LI_COI_DISCL_PROJECTS_IDS
		FROM COI_DISCLOSURE T0
        INNER JOIN COI_DISCL_PROJECTS T1 ON T1.DISCLOSURE_ID = T0.DISCLOSURE_ID
        WHERE T1.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY AND T1.MODULE_CODE = AV_MODULE_CODE AND T0.REVIEW_STATUS_CODE != 4
        AND T0.FCOI_TYPE_CODE <> 2 AND FIND_IN_SET(T0.PERSON_ID, LS_KEY_PERSON_IDS);

        DELETE T4, T3, T2, T1
        FROM COI_DISCL_PROJECTS T1
        LEFT JOIN COI_DISCL_PROJECT_ENTITY_REL T2 ON T2.COI_DISCL_PROJECTS_ID = T1.COI_DISCL_PROJECTS_ID
        LEFT JOIN DISCL_COMMENT T3
            ON T3.SUB_MODULE_ITEM_KEY = CAST(T2.COI_DISCL_PROJECT_ENTITY_REL_ID AS CHAR) AND T3.COMPONENT_TYPE_CODE IN ('1', '6')
            AND T3.MODULE_ITEM_KEY = T1.DISCLOSURE_ID
        LEFT JOIN COI_CONFLICT_HISTORY T4 ON T4.COI_DISCL_PROJECT_ENTITY_REL_ID = T2.COI_DISCL_PROJECT_ENTITY_REL_ID
        WHERE T1.COI_DISCL_PROJECTS_ID IN(LI_COI_DISCL_PROJECTS_IDS);
    END IF;

END

//