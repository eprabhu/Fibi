DELIMITER //
CREATE PROCEDURE COI_INT_GET_ENTITY_DETAILS(IN AV_ENTITY_ID INT)
BEGIN
   
   IF AV_ENTITY_ID IS NOT NULL OR AV_ENTITY_ID <> '' THEN 
      SELECT 
        ETY.ENTITY_ID,
        ESI.SPONSOR_CODE,
        CONVERT(ESOI.ORGANIZATION_ID, CHAR) AS ORGANIZATION_ID,
        SUBSTR(ETY.PRIMARY_NAME, 1, 200) AS PRIMARY_NAME,
        SUBSTR(ETY.PRIMARY_ADDRESS_LINE_1, 1, 80) AS SPONSOR_ADDRESS_LINE_1,
        SUBSTR(ETY.PRIMARY_ADDRESS_LINE_2, 1, 80) AS SPONSOR_ADDRESS_LINE_2,
        ETY.CITY  AS SPONSOR_CITY,
        ETY.STATE AS SPONSOR_STATE,
        ETY.POST_CODE AS SPONSOR_POST_CODE,
        SUBSTR(ETY.COUNTRY_CODE, 1, 3) AS SPONSOR_COUNTRY_CODE,
        SUBSTR(ETY.PRIMARY_ADDRESS_LINE_1, 1, 80) AS ORG_ADDRESS_LINE_1,
        SUBSTR(ETY.PRIMARY_ADDRESS_LINE_2, 1, 80) AS ORG_ADDRESS_LINE_2,
        ETY.CITY  AS ORG_CITY,
        ETY.STATE AS ORG_STATE,
        ETY.POST_CODE AS ORG_POST_CODE,
        SUBSTR(ETY.COUNTRY_CODE, 1, 3) AS ORG_COUNTRY_CODE,
        ETY.CERTIFIED_EMAIL,
        ETY.CREATED_BY,
        ETY.UPDATED_BY,
        ETY.NUMBER_OF_EMPLOYEES,
        SUBSTR(ETY.FEDERAL_EMPLOYER_ID, 1, 15) AS FEDERAL_EMPLOYER_ID,
        ETY.UEI_NUMBER,
        ETY.CAGE_NUMBER,
        ETY.INCORPORATION_DATE,
        ETY.INCORPORATED_IN,
        ETY.DUNS_NUMBER,
        ETY.ENTITY_ID,
        SUBSTR(ESI.SPONSOR_TYPE_CODE,1,3) AS SPONSOR_TYPE_CODE,
        SUBSTR(ESI.CUSTOMER_NUMBER,1,40) AS CUSTOMER_NUMBER,
        SUBSTR(ESI.AUDIT_REPORT_SENT_FOR_FY,1,4) AS AUDIT_REPORT_SENT_FOR_FY,
        SUBSTR(ESI.ACRONYM,1,10) AS ACRONYM,
         SUBSTR(ESI.DUNNING_CAMPAIGN_ID,1,6) AS DUNNING_CAMPAIGN_ID,
        SUBSTR(ESI.DODAC_NUMBER,1,20) AS DODAC_NUMBER,
        SUBSTR(ESOI.IRS_TAX_EXEMPTION,1,30) AS IRS_TAX_EXEMPTION,
        SUBSTR(ESOI.MASS_TAX_EXEMPT_NUM,1,30) AS MASS_TAX_EXEMPT_NUM,
        SUBSTR(ESOI.AGENCY_SYMBOL,1,30) AS AGENCY_SYMBOL,
        SUBSTR(ESOI.VENDOR_CODE,1,30) AS VENDOR_CODE,
        SUBSTR(ESOI.COM_GOV_ENTITY_CODE,1,30) AS COM_GOV_ENTITY_CODE,
        SUBSTR(ESOI.MASS_EMPLOYEE_CLAIM,1,30)AS MASS_EMPLOYEE_CLAIM,
        SUBSTR(ETY.HUMAN_SUB_ASSURANCE,1,30) AS HUMAN_SUB_ASSURANCE,
        SUBSTR(ETY.ANIMAL_WELFARE_ASSURANCE,1,20) AS ANIMAL_WELFARE_ASSURANCE,
        ESOI.SCIENCE_MISCONDUCT_COMPL_DATE,
        SUBSTR(ESOI.PHS_ACOUNT,1,30) AS PHS_ACOUNT,
        SUBSTR(ESOI.NSF_INSTITUTIONAL_CODE,1,30) AS NSF_INSTITUTIONAL_CODE,
        ESOI.INDIRECT_COST_RATE_AGREEMENT,
        SUBSTR(CONVERT(ESOI.COGNIZANT_AUDITOR,UNSIGNED),1,6) AS COGNIZANT_AUDITOR,
        SUBSTR(CONVERT(ESOI.ONR_RESIDENT_REP,UNSIGNED),1,6) AS ONR_RESIDENT_REP,
        ESOI.LOBBYING_REGISTRANT,
        ESOI.LOBBYING_INDIVIDUAL,
        ESOI.SAM_EXPIRATION_DATE,
        ESI.FEED_STATUS_CODE as SPONSOR_FEED_STATUS_CODE,
        ESOI.FEED_STATUS_CODE as ORG_FEED_STATUS_CODE,
        (SELECT SUBSTR(CONVERT(ET.TELEPHONE_NUMBER , CHAR),1,20)
         FROM ENTITY_TELEPHONE ET 
         WHERE ET.ENTITY_ID = ETY.ENTITY_ID 
         LIMIT 1
        ) AS TELEPHONE_NUMBER,
        ERL.DESCRIPTION AS RISK_LEVEL
    FROM ENTITY ETY
    LEFT JOIN ENTITY_SPONSOR_INFO ESI ON ESI.ENTITY_ID = ETY.ENTITY_ID
    LEFT JOIN ENTITY_SUB_ORG_INFO ESOI ON ESOI.ENTITY_ID = ETY.ENTITY_ID
    LEFT JOIN ENTITY_RISK ER ON ER.ENTITY_ID = ETY.ENTITY_ID AND ER.RISK_TYPE_CODE = '5'
    LEFT JOIN ENTITY_RISK_LEVEL ERL ON ERL.RISK_LEVEL_CODE = ER.RISK_LEVEL_CODE
    WHERE ETY.ENTITY_ID = AV_ENTITY_ID
	AND (ESI.FEED_STATUS_CODE IN ('2', '4')
    OR ESOI.FEED_STATUS_CODE IN ('2', '4'));
    
    ELSE
    
          SELECT 
        ETY.ENTITY_ID,
        ESI.SPONSOR_CODE,
        CONVERT(ESOI.ORGANIZATION_ID, CHAR) AS ORGANIZATION_ID,
        SUBSTR(ETY.PRIMARY_NAME, 1, 200) AS PRIMARY_NAME,
        SUBSTR(ETY.PRIMARY_ADDRESS_LINE_1, 1, 80) AS SPONSOR_ADDRESS_LINE_1,
        SUBSTR(ETY.PRIMARY_ADDRESS_LINE_2, 1, 80) AS SPONSOR_ADDRESS_LINE_2,
        ETY.CITY  AS SPONSOR_CITY,
        ETY.STATE AS SPONSOR_STATE,
        ETY.POST_CODE AS SPONSOR_POST_CODE,
        SUBSTR(ETY.COUNTRY_CODE, 1, 3) AS SPONSOR_COUNTRY_CODE,
        SUBSTR(ETY.PRIMARY_ADDRESS_LINE_1, 1, 80) AS ORG_ADDRESS_LINE_1,
        SUBSTR(ETY.PRIMARY_ADDRESS_LINE_2, 1, 80) AS ORG_ADDRESS_LINE_2,
        ETY.CITY  AS ORG_CITY,
        ETY.STATE AS ORG_STATE,
        ETY.POST_CODE AS ORG_POST_CODE,
        SUBSTR(ETY.COUNTRY_CODE, 1, 3) AS ORG_COUNTRY_CODE,
        ETY.CERTIFIED_EMAIL,
        ETY.CREATED_BY,
        ETY.UPDATED_BY,
        ETY.NUMBER_OF_EMPLOYEES,
        SUBSTR(ETY.FEDERAL_EMPLOYER_ID, 1, 15) AS FEDERAL_EMPLOYER_ID,
        ETY.UEI_NUMBER,
        ETY.CAGE_NUMBER,
        ETY.INCORPORATION_DATE,
        ETY.INCORPORATED_IN,
        ETY.DUNS_NUMBER,
        ETY.ENTITY_ID,
        SUBSTR(ESI.SPONSOR_TYPE_CODE,1,3) AS SPONSOR_TYPE_CODE,
        SUBSTR(ESI.CUSTOMER_NUMBER,1,40) AS CUSTOMER_NUMBER,
        SUBSTR(ESI.AUDIT_REPORT_SENT_FOR_FY,1,4) AS AUDIT_REPORT_SENT_FOR_FY,
        SUBSTR(ESI.ACRONYM,1,10) AS ACRONYM,
         SUBSTR(ESI.DUNNING_CAMPAIGN_ID,1,6) AS DUNNING_CAMPAIGN_ID,
        SUBSTR(ESI.DODAC_NUMBER,1,20) AS DODAC_NUMBER,
        SUBSTR(ESOI.IRS_TAX_EXEMPTION,1,30) AS IRS_TAX_EXEMPTION,
        SUBSTR(ESOI.MASS_TAX_EXEMPT_NUM,1,30) AS MASS_TAX_EXEMPT_NUM,
        SUBSTR(ESOI.AGENCY_SYMBOL,1,30) AS AGENCY_SYMBOL,
        SUBSTR(ESOI.VENDOR_CODE,1,30) AS VENDOR_CODE,
        SUBSTR(ESOI.COM_GOV_ENTITY_CODE,1,30) AS COM_GOV_ENTITY_CODE,
        SUBSTR(ESOI.MASS_EMPLOYEE_CLAIM,1,30)AS MASS_EMPLOYEE_CLAIM,
        SUBSTR(ETY.HUMAN_SUB_ASSURANCE,1,30) AS HUMAN_SUB_ASSURANCE,
        SUBSTR(ETY.ANIMAL_WELFARE_ASSURANCE,1,20) AS ANIMAL_WELFARE_ASSURANCE,
        ESOI.SCIENCE_MISCONDUCT_COMPL_DATE,
        SUBSTR(ESOI.PHS_ACOUNT,1,30) AS PHS_ACOUNT,
        SUBSTR(ESOI.NSF_INSTITUTIONAL_CODE,1,30) AS NSF_INSTITUTIONAL_CODE,
        ESOI.INDIRECT_COST_RATE_AGREEMENT,
        SUBSTR(CONVERT(ESOI.COGNIZANT_AUDITOR,UNSIGNED),1,6) AS COGNIZANT_AUDITOR,
        SUBSTR(CONVERT(ESOI.ONR_RESIDENT_REP,UNSIGNED),1,6) AS ONR_RESIDENT_REP,
        ESOI.LOBBYING_REGISTRANT,
        ESOI.LOBBYING_INDIVIDUAL,
        ESOI.SAM_EXPIRATION_DATE,
        ESI.FEED_STATUS_CODE as SPONSOR_FEED_STATUS_CODE,
        ESOI.FEED_STATUS_CODE as ORG_FEED_STATUS_CODE,
        (SELECT SUBSTR(CONVERT(ET.TELEPHONE_NUMBER , CHAR),1,20)
         FROM ENTITY_TELEPHONE ET 
         WHERE ET.ENTITY_ID = ETY.ENTITY_ID 
         LIMIT 1
        ) AS TELEPHONE_NUMBER,
        ERL.DESCRIPTION AS RISK_LEVEL
    FROM ENTITY ETY
    LEFT JOIN ENTITY_SPONSOR_INFO ESI ON ESI.ENTITY_ID = ETY.ENTITY_ID
    LEFT JOIN ENTITY_SUB_ORG_INFO ESOI ON ESOI.ENTITY_ID = ETY.ENTITY_ID
    LEFT JOIN ENTITY_RISK ER ON ER.ENTITY_ID = ETY.ENTITY_ID AND ER.RISK_TYPE_CODE = '5'
    LEFT JOIN ENTITY_RISK_LEVEL ERL ON ERL.RISK_LEVEL_CODE = ER.RISK_LEVEL_CODE
    WHERE (ESI.FEED_STATUS_CODE IN ('2', '4')
    OR ESOI.FEED_STATUS_CODE IN ('2', '4'));
    
    END IF;

END
//
