DELIMITER //
CREATE PROCEDURE `GET_COMPONENT_RULE_ID`(
    IN AV_FORM_ID INT,
    IN AV_SECTION_ID INT,
    IN AV_COMPONENT_ID INT
)
BEGIN
    DECLARE LI_FORM_BUILDER_SECT_COMP_ID INT;
    DECLARE DONE1 INT DEFAULT FALSE;
    
    DECLARE COMP_FORM_ID_CURSOR CURSOR FOR 
        SELECT FORM_BUILDER_SECT_COMP_ID 
        FROM FORM_BUILDER_SECTION_COMPONENT 
        WHERE FORM_BUILDER_SECTION_ID IN 
            (SELECT FORM_BUILDER_SECTION_ID 
             FROM FORM_BUILDER_SECTION 
             WHERE FORM_BUILDER_ID = AV_FORM_ID AND IS_ACTIVE = 'Y');
    
    DECLARE COMP_SECT_ID_CURSOR CURSOR FOR 
        SELECT FORM_BUILDER_SECT_COMP_ID 
        FROM FORM_BUILDER_SECTION_COMPONENT 
        WHERE FORM_BUILDER_SECTION_ID = AV_SECTION_ID AND IS_ACTIVE = 'Y';

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = TRUE;
    
    CREATE TEMPORARY TABLE IF NOT EXISTS RESULT_TABLE (
        FORM_BUILDER_SECT_COMP_ID INT,
        RULE_ID INT
    );

    IF AV_FORM_ID IS NOT NULL THEN
        OPEN COMP_FORM_ID_CURSOR;
        
        COMP_FORM_ID_CURSOR_LOOP: LOOP
            FETCH COMP_FORM_ID_CURSOR INTO LI_FORM_BUILDER_SECT_COMP_ID;
            
            IF DONE1 THEN
                LEAVE COMP_FORM_ID_CURSOR_LOOP;
            END IF;
            
            INSERT INTO RESULT_TABLE (FORM_BUILDER_SECT_COMP_ID, RULE_ID)
            SELECT FORM_BUILDER_SECT_COMP_ID, RULE_ID
            FROM form_section_component_rules 
            WHERE FORM_BUILDER_SECT_COMP_ID = LI_FORM_BUILDER_SECT_COMP_ID
            AND IS_ACTIVE = 'Y';

        END LOOP;
        CLOSE COMP_FORM_ID_CURSOR;
        
    ELSEIF AV_SECTION_ID IS NOT NULL THEN
        OPEN COMP_SECT_ID_CURSOR;
        
        COMP_SECT_ID_CURSOR_LOOP: LOOP
            FETCH COMP_SECT_ID_CURSOR INTO LI_FORM_BUILDER_SECT_COMP_ID;
            
            IF DONE1 THEN
                LEAVE COMP_SECT_ID_CURSOR_LOOP;
            END IF;

            INSERT INTO RESULT_TABLE (FORM_BUILDER_SECT_COMP_ID, RULE_ID)
            SELECT FORM_BUILDER_SECT_COMP_ID, RULE_ID
            FROM form_section_component_rules 
            WHERE FORM_BUILDER_SECT_COMP_ID = LI_FORM_BUILDER_SECT_COMP_ID
            AND IS_ACTIVE = 'Y';

        END LOOP;
        CLOSE COMP_SECT_ID_CURSOR;

    ELSEIF AV_COMPONENT_ID IS NOT NULL THEN
        INSERT INTO RESULT_TABLE (FORM_BUILDER_SECT_COMP_ID, RULE_ID)
        SELECT FORM_BUILDER_SECT_COMP_ID, RULE_ID
        FROM form_section_component_rules 
        WHERE FORM_BUILDER_SECT_COMP_ID = AV_COMPONENT_ID
        AND IS_ACTIVE = 'Y';
    END IF;
    
	SELECT FORM_BUILDER_SECT_COMP_ID, GROUP_CONCAT(RULE_ID) 
	FROM RESULT_TABLE 
	GROUP BY FORM_BUILDER_SECT_COMP_ID;

    DROP TEMPORARY TABLE IF EXISTS RESULT_TABLE;
    
END
//
